---
ref: goc218-labs
title: GOC218 Labs
date: 2023-09-08T00:00:00+00:00
layout: page
lang: sk
permalink: /goc218/
sitemap: false
---

## Lab Environment

### Virtual Machines

Here is a list of VMs you will find in the lab environment:

| Name        | Operating System      | Description                      |
|-------------|-----------------------|----------------------------------|
| GOC218-DC   | Windows Server 2022   | AD Domain Services (contoso.com) |
| GOC218-SYNC | Windows Server 2022   | AAD Connect                      |
| GOC218-ADFS | Windows Server 2022   | AD Federation Services           |
| GOC218-PC1  | Windows 11 Enterprise | Domain PC                        |
| GOC218-PC2  | Windows 11 Enterprise | Domain PC                        |
| GOC218-PC3  | Windows 11 Enterprise | Workgroup PC                     |
| GOC218-PC4  | Windows 11 Enterprise | Workgroup PC                     |

### Credentials

| User             | Password     |
|------------------|--------------|
| CONTOSO\Admin    | Pa$$w0rd     |
| CONTOSO\vance    | CXW43EPI4ES* |
| CONTOSO\park     | Password123  |
| CONTOSO\kirkland | Password123  |
| CONTOSO\galloway | Hello123     |
| CONTOSO\simmons  | Hello123     |
| CONTOSO\wilson   | Contoso2020  |
| GOC218-PC3\Admin | Pa$$w0rd     |
| GOC218-PC4\Admin | Pa$$w0rd     |

## Course Preparation

In order to test Azure AD features and perform the lab assignments, you will need to create your own free Azure AD tenant. Here is how:

1. Create a [personal Microsoft account](https://account.microsoft.com/account/) in case you have none. Microsoft accounts typically end with `@outlook.com` or `@live.com` and can also be mapped to a custom e-mail address.

2. Register for the [Microsoft 365 Developer Program](https://developer.microsoft.com/en-us/microsoft-365/dev-program) using this personal Microsoft account.

3. Create a [Microsoft 365 Developer Sandbox](https://developer.microsoft.com/en-us/microsoft-365/profile), while choosing the Instant option and a European datacenter. Please bear in mind this operation might take up to 2 days, although it is typically only takes a few seconds.

## Module 1: Microsoft Entra ID Management

### Task 1.1 Explore Microsoft Entra ID Management Portals

#### Admin Portals

- [entra.microsoft.com](https://entra.microsoft.com)
- [portal.azure.com](https://portal.azure.com)
- [aad.portal.azure.com](https://aad.portal.azure.com)
- [portal.microsoft.com](https://portal.microsoft.com)
- [endpoint.microsoft.com](https://endpoint.microsoft.com)
- [security.microsoft.com](https://security.microsoft.com)
- [Legacy MFA Portal](https://account.activedirectory.windowsazure.com/usermanagement/multifactorverification.aspx)

#### End-User Portals

- [myapps.microsoft.com](https://myapps.microsoft.com)
- [myaccount.microsoft.com](https://myaccount.microsoft.com)
- [myaccount.microsoft.com/device-list](https://myaccount.microsoft.com/device-list)
- [myaccount.microsoft.com/groups](https://myaccount.microsoft.com/groups)
- [myaccount.microsoft.com/organizations](https://myaccount.microsoft.com/organizations)
- [mysignins.microsoft.com](https://mysignins.microsoft.com)
- [mysignins.microsoft.com/security-info](https://mysignins.microsoft.com/security-info) OR [aka.ms/mysecurityinfo](https://aka.ms/mysecurityinfo)
- [myaccess.microsoft.com](https://myaccess.microsoft.com)
- [Password Change Portal](https://account.activedirectory.windowsazure.com/ChangePassword.aspx)
- [passwordreset.microsoftonline.com/](https://passwordreset.microsoftonline.com) OR [aka.ms/sspr](https://aka.ms/sspr)

### Task 1.2: Register a custom domain name

1. Register a custom domain called `<givenname>.goc218.dsinternals.com`.
2. Send the DNS TXT verification code to your trainer (`\\lektor921\DNS\<givenname>.txt`).
3. Check that all the required DNS records are present:
    - `enterpriseregistration CNAME enterpriseregistration.windows.net`
    - `enterpriseenrollment CNAME enterpriseenrollment.manage.microsoft.com`
    - `autodiscover CNAME autodiscover.outlook.com`
    - `. TXT v=spf1 include:spf.protection.outlook.com -all`
    - `. MX 0 $domain-goc218-dsinternals-com.mail.protection.outlook.com`
4. Modify the UPN suffix of user Diego to the newly registered domain name.

### Task 1.3: Assign the Global Admins role to your account

1. Invite your personal MS account.
2. Convert it to a Member
3. Assign the Global Admins role to this account.

### Task 1.4: Turn on Passwordless Authentication

1. Enable the following passwordless authentication methods in Azure AD:
    - Microsoft Authenticator
    - FIDO2 Security Keys
    - Temporary Access Pass
2. Configure a new Temporary Access Pass for user Diego.
3. Try signing in as Diego using the Temporary Access Pass.

### Task 1.5: Disable SMS authentication

Open the legacy MFA portal and disable SMS authentication. Note that this would prevent an attack called SIM Jacking.

### Task 1.6: Migrate to the Authentication methods policy

Follow the [official guide from Microsoft](https://learn.microsoft.com/en-us/azure/active-directory/authentication/how-to-authentication-methods-manage).

### Task 1.7: Configure a custom list of banned passwords

Set these passwords as banned in [AAD Password Protection](https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-password-ban-bad):

- Contoso
- Gopas
- Praha
- Brno
- Bratislava

### Task 1.8: Deploy AAD Password Protection in Hybrid Mode

This task is optional. Follow the [official guide from Microsoft](https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-password-ban-bad-on-premises).

### Task 1.9: Disable Password Expiration

### Task 1.10: Enable SSPR

1. Enable the Self-Service Password Reset feature for all users.
2. Check the Authentication methods Activity report.

### Task 1.11 PowerShell

#### Microsoft Graph Module

```powershell
# Temporary Access Pass provisioning using PowerShell:
Install-Module Microsoft.Graph.Authentication -Force
Install-Module Microsoft.Graph.Users -Force
Install-Module Microsoft.Graph.Identity.SignIns -Force
Install-Module Microsoft.Graph.Identity.DirectoryManagement -Force

Disconnect-MgGraph
Connect-MgGraph -Scopes 'User.ReadWrite.All','UserAuthenticationMethod.ReadWrite.All'
Select-MgProfile -Name 'beta'

Add-Type -AssemblyName System.Web
$passwordProfile = @{
    Password = [System.Web.Security.Membership]::GeneratePassword(128,1)
    ForceChangePasswordNextSignIn = $false
}

New-MgUser -DisplayName 'Josef Novak' `
           -UserPrincipalName 'jnovak@XXXX.goc218.dsinternals.com' `
           -PasswordProfile $passwordProfile `
           -AccountEnabled `
           -MailNickName 'JosefNovak' `
           -GivenName Josef `
           -Surname Novak

New-MgUserAuthenticationTemporaryAccessPassMethod `
     -UserId 'jnovak@XXXX.goc218.dsinternals.com' `
     -IsUsableOnce `
     -LifetimeInMinutes 60 | Format-List

$currentTempPass = Get-MgUserAuthenticationTemporaryAccessPassMethod -UserId 'jnovak@XXXX.goc218.dsinternals.com'
if($null -ne $currentTempPass)
{
    Remove-MgUserAuthenticationTemporaryAccessPassMethod `
        -UserId 'jnovak@XXXX.goc218.dsinternals.com' `
        -TemporaryAccessPassAuthenticationMethodId $currentTempPass.Id
}
```

#### AzureAD Module

```powershell
Install-Module -Name AzureAD
Connect-AzureAD
Get-AzureADUser -All $true
Get-AzureADUser -ObjectId 0c09ad32-478f-4c9d-9144-eba3d12e4abf | Select-Object -Property *
Get-AzureADUser -SearchString michael
Get-AzureADUser -ObjectId 'michael@XXXX.goc218.dsinternals.com'
Get-AzureADUser -Filter "UserPrincipalName eq 'michael@XXXX.goc218.dsinternals.com'"
Get-AzureADUser -Filter "City eq 'Bloomington'"
Get-AzureADUser -All $true | Where-Object UserPrincipalName -like '*#EXT#*'

Get-AzureADUser -ObjectId 'HenriettaM@18q8bb.onmicrosoft.com'
Set-AzureADUser -ObjectId 4da845a9-a36c-44ad-ac0e-ce15110c9a39 -UserPrincipalName 'Henrietta@XXXX.goc218.dsinternals.com'

Get-AzureADUser -All $true |
    Select-Object -Property UserPrincipalName,GivenName,Surname,ObjectId,@{ n = 'External'; e = { $PSItem.UserPrincipalName -like '*#EXT#*' } } |
    Export-Csv -Path E:\aadusers.csv -Force -Delimiter ',' -NoTypeInformation

# Deleting objects
Remove-AzureADUser -ObjectId 'Grady@XXXX.goc218.dsinternals.com'

# User account creation
Add-Type -AssemblyName System.Web
$initialPassword = [System.Web.Security.Membership]::GeneratePassword(12,1)

$passwordProfile = [Microsoft.Open.AzureAD.Model.PasswordProfile]::new()
$passwordProfile.ForceChangePasswordNextLogin = $true
$passwordProfile.Password = $initialPassword

New-AzureADUser -UserPrincipalName 'test3@XXXX.goc218.dsinternals.com' `
                -MailNickName 'test' `
                -AccountEnabled $true `
                -DisplayName 'Test3' `
                -PasswordProfile $passwordProfile

Set-AzureADUserPassword -ObjectId 'test3@XXXX.goc218.dsinternals.com' `
                        -ForceChangePasswordNextLogin $false `
                        -EnforceChangePasswordPolicy $true
```

#### MSOnline Module

```powershell
Install-Module -Name MSOnline
Connect-MsolService
Get-MsolUser -All
Get-MsolUser -UserPrincipalName 'michael.grafnetter_outlook.com#EXT#@18q8bb.onmicrosoft.com'
Get-MsolUser -ObjectId 0c09ad32-478f-4c9d-9144-eba3d12e4abf
```

#### Azure Resources Module

```powershell
Install-Module -Name Az.Resources -Force
Connect-AzAccount
Get-AzADUser
```

### Additional Tasks

- Company branding
- Tenant properties
- User settings
- Groups
- Roles and Administrators
- Administrative units
- Licenses

## Module 2: Hybrid Identity

### Task 2.1: Deploy Azure AD Connect

- Server: GOC218-SYNC
- Authentication method: Password Hash Sync + Seamless SSO
- Scopes
  - OU=InitialCloudSync,OU=Employees,DC=contoso,DC=com
  - OU=Contacts,DC=contoso,DC=com
  - CN=Computers,DC=contoso,DC=com
- Resolve the duplicate user object of Adele Vance
- Set UPN suffixes of employees to @givenname.lab.dsinternals.com
- Also register the @...onmicrosoft.com UPN suffix in AD.
- Extend the sync scope to OU=Employees,DC=contoso,DC=com

### Task 2.2 Dealing with duplicate accounts


```powershell
##### Option A ####

# Local
Get-AzureADUser -ObjectId adele.vance@aadcourse.onmicrosoft.com

# GOC218-DC
Set-ADUser -Identity vance -Replace @{ 'adminDescription' = 'User_' }

# GOC218-SYNC
Start-ADSyncSyncCycle

# Local
Remove-AzureADMSDeletedDirectoryObject -Id 133b6da5-8a78-49e5-a665-5e69a2b702c8

# Fix UPNs

# GOC218-DC
Set-ADUser -Identity vance -Clear 'adminDescription'

# GOC218-SYNC
Start-ADSyncSyncCycle

##### Option B ####

# GOC218-DC
Set-ADUser -Identity vance -Replace @{ 'adminDescription' = 'User_' }

# GOC218-SYNC
Start-ADSyncSyncCycle

# GOC218-DC
$newId = New-Guid
[System.Convert]::ToBase64String($newId.ToByteArray())
Set-ADUser -Identity vance -Replace @{ 'ms-DS-ConsistencyGuid' = '5a37e89c-3b16-4bab-a10c-5b95d37595ca' }

# Local
Connect-AzureAD
Set-AzureADUser -ObjectId 'AdeleV@18q8bb.onmicrosoft.com' -ImmutableId 'nOg3WhY7q0uhDFuV03WVyg=='

# GOC218-DC
Set-ADUser -Identity vance -Clear 'adminDescription'

# GOC218-SYNC
Start-ADSyncSyncCycle
```


```powershell
# Copy ImmutableID to ms-DS-ConsistencyGuid
Connect-AzureAD
$user = Get-AzureADUser -ObjectId 'AdeleV@18q8bb.onmicrosoft.com'
$consistencyId = [System.BitConverter]::ToString([System.Convert]::FromBase64String($user.ImmutableId)).Replace('-', ' ')
Set-ADUser -Identity vance -Replace @{ 'ms-DS-ConsistencyGuid' = 'E7 DC 01 B4 E7 75 9E 42 A7 A7 15 DC 8D D2 3A F4' }

Set-ADUser -Identity vance -Replace @{ 'adminDescription' = 'User_' }
Set-ADUser -Identity vance -Clear 'adminDescription'

# Calculating the immutable ID
# (Get-ADUser -Identity vance).ObjectGUID
[guid] $objectGuid = 'b401dce7-75e7-429e-a7a7-15dc8dd23af4'
[string] $immutableId = [System.Convert]::ToBase64String($objectGuid.ToByteArray())

# Injecting the immutable ID
Connect-AzureAD
Set-AzureADUser -ObjectId 'AdeleV@18q8bb.onmicrosoft.com' -ImmutableId $immutableId

# Resolve the conflict
Remove-MsolUser -ObjectId 133b6da5-8a78-49e5-a665-5e69a2b702c8 -RemoveFromRecycleBin -Force
```

### Task 2.2: Deploy AD Connect Health

Targets:

- AD DS: GOC218-DC
- AD FS: GOC218-ADFS

### Task 2.3: Enable federation with AD FS

- Test that your local ADFS deployment is working by visiting the https://login.contoso.com/adfs/ls/idpinitiatedsignon.htm website that is running on the CONTOSO-ADFS server.
- Use the default `.onmicrosoft.com` account to reconfigure AD Connect.
- Enable federation on the `<givenname>.lab.dsinternals.com` domain.

## Module 3: Managing Windows Endpoints

### Task 3.1: Enable FIDO2 Hybrid and WHfB Cloud Trust

Follow these [instructions from Microsoft](https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-security-key-on-premises#install-the-azure-ad-kerberos-powershell-module).

### Task 3.2: Test the Seamless SSO

- Log in as CONTOSO\vance to CONTOSO-PC1.
- Add the https://autologon.microsoftazuread-sso.com site to the Intranet Zone.
- Visit the domain-specific URL of the Azure Portal: https://portal.azure.com/givenname.lab.dsinternals.com

### Task 3.4: Configure Hybrid computer join

- Ensure that computer accounts are in sync scope.
- Enable Hybrid join in AD Connect.
- Enable Hybrid Join in GPO.
- Test it on CONTOSO-PC1.

### Task 3.5: Deploy WHfB Hybrid with Key Trust

Test user: CONTOSO\vance.

### Task 3.6: Cloud-joined and registered PCs

- Assign the EMS E5 license to Adele Vance.
- Enable Microsoft Intune in your tenant.
- Join CONTOSO-PC3 to AAD.
- Register CONTOSO-PC4 in AAD.
- Check the device properties in https://aad.portal.azure.com.
- Check the device properties in https://endpoint.microsoft.com.

## Module 4: Application Integration

### Task 4.1: Configure SSO to Claims X-Ray

1. Set these options for SAML SSO:
  - Name: Claims X-Ray
  - Entity ID: urn:microsoft:adfs:claimsxray
  - Assertion Consumer Service URL: https://adfshelp.microsoft.com/ClaimsXray/TokenResponse
  - Logo: https://adfshelp.microsoft.com/Content/Images/OnlineTools/ClaimsXRay.svg
2. Sign-in to https://portal.azure.com as Adele Vance from CONTOSO-PC1.
3. Check the myapps.microsoft.com portal.
4. Only allow access to Claims X-Ray from compliant devices.

<!--
1. Create a new Enterprise application with these settings:
  - Name: Claims X-Ray
  - SSO Method: SAML
  - Entity ID: urn:microsoft:adfs:claimsxray
  - Assertion Consumer Service URL: https://adfshelp.microsoft.com/ClaimsXray/TokenResponse
  - Logo: https://adfshelp.microsoft.com/Content/Images/OnlineTools/ClaimsXRay.svg
2. Assign the Claims X-Ray app to Adele Vance.
3. Sign in as Adele Vance to the My Apps portal (https://myapps.microsoft.com) and verify that you are able to access the Claims X-Ray app.
4. Create a Conditional Access Policy that requires all users to perform MFA when accessing the Claims X-Ray app.
-->

### Task 4.2: Create a script running as a scheduled tasks

```powershell
New-SelfSignedCertificate -Subject "CN=$env:COMPUTERNAME Azure Authentication" `
                          -KeyAlgorithm RSA `
                          -KeyLength 2048 `
                          -KeyLocation Cert:\LocalMachine\My `
                          -KeyExportPolicy NonExportable `
                          -Provider 'Microsoft Platform Crypto Provider' `
                          -NotAfter (Get-Date).AddYears(1)
```


Additional:
Configure Device Writeback

```powershell
#Requires -Modules ActiveDirectory

Get-ADObject -SearchBase 'CN=RegisteredDevices,DC=contoso,DC=com' `
             -LDAPFilter '(objectClass=msDS-Device)' `
             -Properties displayName,msDS-DeviceOSType,msDS-DeviceOSVersion,msDS-IsEnabled,msDS-IsManaged,whenCreated |
    Select-Object -Property name,displayName,msDS-DeviceOSType,msDS-DeviceOSVersion,msDS-IsEnabled,msDS-IsManaged,whenCreated |
    Out-GridView -Title Devices -Wait
```


Adele,Vance,CXW43EPI4ES*




Create a compliance policy:
  Name: Windows 10 Security Baseline
  Checks: TPM present, AV present
  Target: All Devices

Enroll CONTOSO-PC4 into MDM

Test compliance

Create a Group:
  Name: VIP Employees
  Members: AdeleV

Create a new CAP:
  Name: Require Device Compliance for VIP Employees
  Users: VIP Employees group
  Apps: All apps
  Grant: Require compliant device

Test the compliance policy:
  - CONTOSO-PC4
  - Your computer


Create a Named Location called HQ and configure it with the public IP address of the CONTOSO-PC4 VM.

Create a Conditional Access Policy that allows access to the Claims X-Ray app only from the HQ.

Test the policy on your local computer and on CONTOSO-PC4 as AdeleV.



Register Azure VPN
https://login.microsoftonline.com/common/oauth2/authorize?client_id=41b23e61-6c1e-4545-b367-cd054e0ed4b4&response_type=code&redirect_uri=https://portal.azure.com&nonce=1234&prompt=admin_consent


## Module 5: Identity Governance

```bash
wsl --install --distribution kali-linux

sudo wget http://archive.kali.org/archive-key.asc -O /etc/apt/trusted.gpg.d/kali-archive-key.asc
sudo apt update
sudo apt install libcrypt1 -y
sudo apt install python3-pip -y
sudo pip install --upgrade setuptools
sudo pip install --upgrade pip
sudo pip install roadrecon

roadrecon auth --device-code
roadrecon gather --mfa
roadrecon plugin xlsexport
roadrecon plugin policies
roadrecon gui
```

### Task 5.2: Enable and configure PIM

Follow these assignments in the official MS-500 course:
- https://github.com/MicrosoftLearning/MS-500-Microsoft-365-Security/blob/master/Instructions/Labs/MS500T00/LAB_AK_03_Lab2_Ex1_EnablePIM.md
- https://github.com/MicrosoftLearning/MS-500-Microsoft-365-Security/blob/master/Instructions/Labs/MS500T00/LAB_AK_03_Lab2_Ex2_RoleAssignments.md
- https://github.com/MicrosoftLearning/MS-500-Microsoft-365-Security/blob/master/Instructions/Labs/MS500T00/LAB_AK_03_Lab2_Ex3_Activate_Deactivate_PIM_Roles.md
- https://github.com/MicrosoftLearning/MS-500-Microsoft-365-Security/blob/master/Instructions/Labs/MS500T00/LAB_AK_03_Lab2_Ex4_Directory_Roles.md
- https://github.com/MicrosoftLearning/MS-500-Microsoft-365-Security/blob/master/Instructions/Labs/MS500T00/LAB_AK_03_Lab2_Ex5_PIM_Resource_Workflows.md
- https://github.com/MicrosoftLearning/MS-500-Microsoft-365-Security/blob/master/Instructions/Labs/MS500T00/LAB_AK_03_Lab2_Ex6_Audit_History.md

<!--
Enable PIM in your tenant and apply following policy to the Global Admins role:
-	Require MFA: yes
-	Notification: yes
-	Incident ticket: yes
-	Require approval: yes
-	Approver: Other Global Admins
-	Activation Duration: 1 hour
-	Permanent admin: Emergency access account (your default account)
-	Eligible users: Adele Vance

-->
