---
ref: ioc-shadowcreds
title: "Indicator of Compromise: NTLM Relay Attack with Shadow Credentials"
date: '2025-02-23T00:00:00+00:00'
layout: post
lang: en
permalink: /en/indicator-of-compromise-shadow-credentials-ntlm-relay-impacket/
---

## TL;DR

The current implementation of&nbsp;the&nbsp;shadow credentials attack in&nbsp;the&nbsp;`Impacket` framework,
most notably used by&nbsp;the&nbsp;`ntlmrelayx.py` script, contains multiple bugs,
leaving unique signatures on the&nbsp;NGC data structures written to&nbsp;the&nbsp;`msDS-KeyCredentialLink` LDAP attribute by&nbsp;malicious actors.
Heuristics could be&nbsp;used to&nbsp;identify most malicious NGC keys, regardless of&nbsp;the&nbsp;hacktool they were generated by.

## Technical Details

I noticed by&nbsp;chance that&nbsp;the&nbsp;current implementation of&nbsp;the&nbsp;[shadow credentials attack](/en/_posts/2019-12-22-video-black-hat-europe-2019-talk.md)
([a term coined and&nbsp;popularized by&nbsp;Elad Shamir](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab)) in&nbsp;the&nbsp;[Impacket](https://github.com/fortra/impacket)
framework produces malformed [KEYCREDENTIALLINK_BLOB](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/f3f01e95-6d0c-4fe6-8b43-d585167658fa)
binary data structures, having the&nbsp;following issues:

- The&nbsp;`KeyHash` entry should contain a&nbsp;SHA256 hash of&nbsp;all other entries, but&nbsp;it&nbsp;is&nbsp;only calculated from&nbsp;the&nbsp;`KeyMaterial` entry.
- The&nbsp;`KeyCreationTime` entry should be&nbsp;in&nbsp;the&nbsp;[FILETIME](https://learn.microsoft.com/en-us/windows/win32/api/minwinbase/ns-minwinbase-filetime) format but&nbsp;is&nbsp;incorrectly skewed by&nbsp;1600 years.
- The&nbsp;`DeviceId` entry is&nbsp;expected to&nbsp;be&nbsp;present only on user accounts, but&nbsp;it&nbsp;is&nbsp;populated for&nbsp;computer accounts as&nbsp;well. And&nbsp;instead of&nbsp;referencing existing device objects, it&nbsp;contains random values.

These bugs are&nbsp;located in&nbsp;the&nbsp;[shadow_credentials.py](https://github.com/fortra/impacket/blob/master/impacket/examples/ntlmrelayx/utils/shadow_credentials.py) script,
which is&nbsp;then optionally used by&nbsp;the&nbsp;[ntlmrelayx.py](https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py) script when&nbsp;performing the&nbsp;NTLM Relay attack against the&nbsp;LDAP protocol.
The shadow credentials attack was originally implemented in&nbsp;version `0.10.0` of&nbsp;`Impacket`, released in&nbsp;May 2022.
The bugs were introduced to&nbsp;the&nbsp;`master` branch in&nbsp;March 2024 and&nbsp;published in&nbsp;version `0.12.0`, released in&nbsp;September 2024.

As a&nbsp;result, the&nbsp;[DSInternals PowerShell module](https://github.com/MichaelGrafnetter/DSInternals) can&nbsp;be&nbsp;used
to identify malformed NGC keys (AKA shadow credentials) that&nbsp;are&nbsp;still present in&nbsp;Active Directory (AD):

```powershell
#Requires -Modules DSInternals,ActiveDirectory

 Get-ADObject -LDAPFilter '(msDS-KeyCredentialLink=*)' -Properties msDS-KeyCredentialLink |
    Select-Object -ExpandProperty msDS-KeyCredentialLink |
    Get-ADKeyCredential |
    Where-Object Usage -eq NGC
```

Sample output:

```txt
Usage Source  Flags      DeviceId                             Created    Owner
----- ------  -----      --------                             -------    -----
NGC   AD      None       ff53f58e-81a9-5d40-96bb-4980c91008ae 3625-02-23 CN=PC04,CN=Computers,DC=contoso,DC=com
NGC   AD      None       e49d674f-0259-44f3-a3bd-8343b76046fc 2025-02-02 CN=Administrator,CN=Users,DC=contoso,DC=com
NGC   AD      None       cfe9a872-13ff-4751-a777-aec88c30a762 2019-08-01 CN=John Doe,CN=Users,DC=contoso,DC=com
NGC   AzureAD None       fd591087-245c-4ff5-a5ea-c14de5e2b32d 2017-07-19 CN=John Doe,CN=Users,DC=contoso,DC=com
NGC   AD      MFANotUsed                                      2025-02-01 CN=PC01,CN=Computers,DC=contoso,DC=com
NGC   AD      MFANotUsed                                      2017-08-23 CN=PC02,CN=Computers,DC=contoso,DC=com
NGC   AD                                                      2021-06-11 CN=PC03,CN=Computers,DC=contoso,DC=com
```

The first NGC key in&nbsp;the&nbsp;output above, supposedly created in&nbsp;the&nbsp;year 3625 instead of&nbsp;2025,
can serve as&nbsp;a&nbsp;very reliable indicator of&nbsp;AD compromise (IoC).
Moreover, all open-source implementations of&nbsp;the&nbsp;shadow credentials attack generate random values for&nbsp;the&nbsp;`DeviceId` attribute.
It is&nbsp;therefore possible to&nbsp;use Microsoft's [WHfBTools PowerShell module](https://www.powershellgallery.com/packages/WHfBTools) to&nbsp;[identify orphaned NGC keys](https://support.microsoft.com/en-us/topic/using-whfbtools-powershell-module-for-cleaning-up-orphaned-windows-hello-for-business-keys-779d1f3f-bb2d-c495-0f6b-9aeb940eeafb
) with&nbsp;non-existing device identifiers.

The sample data also shows that&nbsp;the&nbsp;[CUSTOMKEYINFO_FLAGS_MFA_NOT_USED](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/701a55dc-d062-4032-a2da-dbdfc384c8cf) flag
in the&nbsp;`CustomKeyInformation` entry is&nbsp;used inconsistently by&nbsp;Windows 10+ computers, making it&nbsp;an&nbsp;unreliable indicator of&nbsp;malicious NGC keys.

## Future Work

As other implementations of&nbsp;the&nbsp;shadow credential attack might contain similar issues,
broader research on this&nbsp;topic should be&nbsp;conducted.
Although hacktool authors will probably react to&nbsp;the&nbsp;information contained in&nbsp;this&nbsp;article and&nbsp;improve their implementations accordingly,
these changes will not affect pre-existing shadow credentials.

Although the&nbsp;current version of&nbsp;`DSInternals` does not validate the&nbsp;`KeyHash` entries when&nbsp;parsing existing NGC keys,
it correctly implements the&nbsp;hash calculation when&nbsp;generating new NGC keys or&nbsp;serializing existing ones.
It should not be&nbsp;hard to&nbsp;implement hash validation as&nbsp;well.
